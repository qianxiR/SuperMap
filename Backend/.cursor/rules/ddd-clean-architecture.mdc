# DDD + æ¸…æ´æ¶æ„å¼€å‘è§„èŒƒ

## æ¶æ„å±‚æ¬¡å…³ç³»

æœ¬é¡¹ç›®é‡‡ç”¨å››å±‚æ¸…æ´æ¶æ„è®¾è®¡ï¼š
- **APIå±‚** (Controller) â†’ **åº”ç”¨å±‚** (Use Case) â†’ **é¢†åŸŸå±‚** (Domain) â†’ **åŸºç¡€è®¾æ–½å±‚** (Infrastructure)

## å„å±‚èŒè´£ä¸ç¼–ç è§„èŒƒ

### ğŸŸ¦ é¢†åŸŸå±‚ (Domain Layer) - ä¸šåŠ¡æ ¸å¿ƒ

**åŸåˆ™**: ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æŠ€æœ¯ï¼ŒåªåŒ…å«ä¸šåŠ¡é€»è¾‘

#### å®ä½“ (Entities)
- ä½ç½®: `analysis/domains/{domain}/entities.py`
- èŒè´£: å®šä¹‰ä¸šåŠ¡æ ¸å¿ƒæ¦‚å¿µå’Œä¸šåŠ¡è§„åˆ™
- è§„èŒƒ:
  - ä½¿ç”¨ `@dataclass` è£…é¥°å™¨
  - åŒ…å«ä¸šåŠ¡éªŒè¯é€»è¾‘
  - æä¾›å·¥å‚æ–¹æ³• `create_new()`
  - ä¸ä¾èµ–å¤–éƒ¨æ¡†æ¶

#### å€¼å¯¹è±¡ (Value Objects)
- ä½ç½®: `analysis/domains/{domain}/value_objects.py`
- èŒè´£: å°è£…ä¸å¯å˜çš„å€¼å’ŒéªŒè¯è§„åˆ™
- è§„èŒƒ:
  - ä½¿ç”¨ `@dataclass(frozen=True)`
  - åœ¨ `__post_init__` ä¸­è¿›è¡ŒéªŒè¯
  - æä¾› `create()` ç±»æ–¹æ³•

#### ä»“å‚¨æ¥å£ (Repository Interface)
- ä½ç½®: `analysis/domains/{domain}/repositories.py`
- èŒè´£: å®šä¹‰æ•°æ®æ“ä½œå¥‘çº¦
- è§„èŒƒ:
  - ä½¿ç”¨æŠ½è±¡åŸºç±» `ABC`
  - å®šä¹‰å¼‚æ­¥æ–¹æ³•
  - ä¸åŒ…å«å…·ä½“å®ç°

#### é¢†åŸŸæœåŠ¡ (Domain Services)
- ä½ç½®: `analysis/domains/{domain}/services.py`
- èŒè´£: å¤æ‚ä¸šåŠ¡é€»è¾‘åè°ƒ
- è§„èŒƒ:
  - ä¾èµ–ä»“å‚¨æ¥å£
  - åŒ…å«ä¸šåŠ¡è§„åˆ™éªŒè¯
  - ä¸å¤„ç†HTTPæˆ–æ•°æ®åº“ç»†èŠ‚

### ğŸŸ¢ åº”ç”¨å±‚ (Application Layer) - ä¸šåŠ¡æµç¨‹ç¼–æ’

**åŸåˆ™**: åè°ƒé¢†åŸŸå±‚ç»„ä»¶ï¼Œä¸åŒ…å«ä¸šåŠ¡è§„åˆ™

#### ç”¨ä¾‹ (Use Cases)
- ä½ç½®: `analysis/application/use_cases/{domain}/`
- èŒè´£: ä¸šåŠ¡æµç¨‹ç¼–æ’
- è§„èŒƒ:
  - ä¾èµ–é¢†åŸŸæœåŠ¡
  - å¤„ç†DTOè½¬æ¢
  - ä¸åŒ…å«ä¸šåŠ¡è§„åˆ™
  - è¿”å›ç»Ÿä¸€æ ¼å¼ç»“æœ

#### DTO (Data Transfer Objects)
- ä½ç½®: `analysis/application/dto/`
- èŒè´£: æ•°æ®ä¼ è¾“å’ŒéªŒè¯
- è§„èŒƒ:
  - ä½¿ç”¨ Pydantic BaseModel
  - åŒ…å«è¾“å…¥éªŒè¯
  - éš”ç¦»å¤–éƒ¨è¯·æ±‚ä¸é¢†åŸŸå®ä½“

### ğŸŸ¡ APIå±‚ (API Layer) - å¯¹å¤–æ¥å£

**åŸåˆ™**: å¤„ç†HTTPè¯·æ±‚/å“åº”ï¼Œå‚æ•°éªŒè¯ï¼Œé”™è¯¯å¤„ç†

#### è·¯ç”± (Routes)
- ä½ç½®: `analysis/api/v1/{domain}/`
- èŒè´£: HTTPæ¥å£å®šä¹‰
- è§„èŒƒ:
  - ä½¿ç”¨ FastAPI è·¯ç”±
  - ä¾èµ–æ³¨å…¥ç”¨ä¾‹
  - ç»Ÿä¸€é”™è¯¯å¤„ç†
  - å‚æ•°éªŒè¯

### ğŸŸ  åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer) - æŠ€æœ¯å®ç°

**åŸåˆ™**: å®ç°å…·ä½“æŠ€æœ¯ç»†èŠ‚ï¼Œä¸ºå†…å±‚æä¾›æ”¯æ’‘

#### ä»“å‚¨å®ç° (Repository Implementation)
- ä½ç½®: `analysis/infrastructure/database/{database}/repositories.py`
- èŒè´£: å…·ä½“æ•°æ®è®¿é—®å®ç°
- è§„èŒƒ:
  - å®ç°é¢†åŸŸå±‚ä»“å‚¨æ¥å£
  - å¤„ç†æ•°æ®åº“è¿æ¥
  - å®ä½“ä¸æ¨¡å‹è½¬æ¢

#### å¤–éƒ¨æœåŠ¡é›†æˆ
- ä½ç½®: `analysis/infrastructure/external/{service}/`
- èŒè´£: ç¬¬ä¸‰æ–¹æœåŠ¡å°è£…
- è§„èŒƒ:
  - å°è£…å¤–éƒ¨APIè°ƒç”¨
  - é”™è¯¯å¤„ç†å’Œé‡è¯•
  - é…ç½®ç®¡ç†

## ä»£ç ç¼–å†™æœ€ä½³å®è·µ

### 1. ä¾èµ–å€’ç½®åŸåˆ™
- å†…å±‚ä¸ä¾èµ–å¤–å±‚
- å¤–å±‚ä¾èµ–å†…å±‚æ¥å£
- ä½¿ç”¨ä¾èµ–æ³¨å…¥å®¹å™¨

### 2. å•ä¸€èŒè´£åŸåˆ™
- æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªèŒè´£
- æ–¹æ³•åŠŸèƒ½å•ä¸€æ˜ç¡®
- é¿å…ä¸Šå¸ç±»

### 3. å¼€é—­åŸåˆ™
- å¯¹æ‰©å±•å¼€æ”¾
- å¯¹ä¿®æ”¹å…³é—­
- ä½¿ç”¨ç­–ç•¥æ¨¡å¼

### 4. æ¥å£éš”ç¦»åŸåˆ™
- å®¢æˆ·ç«¯ä¸ä¾èµ–ä¸éœ€è¦çš„æ¥å£
- æ¥å£åŠŸèƒ½å•ä¸€
- é¿å…èƒ–æ¥å£

## æ–‡ä»¶å‘½åè§„èŒƒ

- å®ä½“: `entities.py`
- å€¼å¯¹è±¡: `value_objects.py`
- ä»“å‚¨: `repositories.py`
- æœåŠ¡: `services.py`
- ç”¨ä¾‹: `{domain}_use_case.py`
- DTO: `{domain}_dto.py`
- API: `{domain}.py`

## å¼€å‘æµç¨‹

1. **ä»é¢†åŸŸå±‚å¼€å§‹**: å®šä¹‰å®ä½“ã€å€¼å¯¹è±¡ã€ä»“å‚¨æ¥å£
2. **å®ç°åº”ç”¨å±‚**: å®šä¹‰DTOã€å®ç°ç”¨ä¾‹
3. **å¼€å‘åŸºç¡€è®¾æ–½å±‚**: å®ç°ä»“å‚¨ã€é›†æˆå¤–éƒ¨æœåŠ¡
4. **æš´éœ²APIæ¥å£**: å®šä¹‰è·¯ç”±ã€å¤„ç†è¯·æ±‚å“åº”

## æµ‹è¯•ç­–ç•¥

- **é¢†åŸŸå±‚**: å•å…ƒæµ‹è¯•ä¸šåŠ¡é€»è¾‘
- **åº”ç”¨å±‚**: é›†æˆæµ‹è¯•ç”¨ä¾‹
- **åŸºç¡€è®¾æ–½å±‚**: é›†æˆæµ‹è¯•æ•°æ®è®¿é—®
- **APIå±‚**: ç«¯åˆ°ç«¯æµ‹è¯•æ¥å£

## å®é™…ä»£ç å®ç°å‚è€ƒ

### é¢†åŸŸå®ä½“ç¤ºä¾‹
```python
# analysis/domains/analysis/entities.py
@dataclass
class AnalysisTask:
    """åˆ†æä»»åŠ¡å®ä½“"""
    id: UUID
    name: str
    description: Optional[str]
    analysis_type: AnalysisType
    parameters: Dict[str, Any]
    status: AnalysisStatus
    created_by: str
    created_at: datetime
    updated_at: datetime
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    progress: float = 0.0
    supermap_request: Optional[SuperMapRequest] = None
    supermap_result: Optional[SuperMapResult] = None
    error_message: Optional[str] = None
    
    @classmethod
    def create_new(
        cls,
        name: str,
        analysis_type: AnalysisType,
        parameters: Dict[str, Any],
        created_by: str,
        description: Optional[str] = None
    ) -> "AnalysisTask":
        """åˆ›å»ºæ–°çš„åˆ†æä»»åŠ¡"""
        return cls(
            id=uuid4(),
            name=name,
            description=description,
            analysis_type=analysis_type,
            parameters=parameters,
            status=AnalysisStatus.PENDING,
            created_by=created_by,
            created_at=datetime.utcnow(),
            updated_at=datetime.utcnow()
        )
```

### é¢†åŸŸæœåŠ¡ç¤ºä¾‹
```python
# analysis/domains/analysis/services.py
class AnalysisService:
    """åˆ†ææœåŠ¡"""
    
    def __init__(
        self,
        task_repository: AnalysisTaskRepository,
        result_repository: AnalysisResultRepository,
        spatial_data_repository: SpatialDataRepository
    ):
        self.task_repository = task_repository
        self.result_repository = result_repository
        self.spatial_data_repository = spatial_data_repository
    
    async def create_analysis_task(
        self,
        name: str,
        analysis_type: AnalysisType,
        parameters: Dict[str, Any],
        created_by: str,
        description: Optional[str] = None
    ) -> AnalysisTask:
        """åˆ›å»ºåˆ†æä»»åŠ¡"""
        task = AnalysisTask.create_new(
            name=name,
            analysis_type=analysis_type,
            parameters=parameters,
            created_by=created_by,
            description=description
        )
        return await self.task_repository.create(task)
```

### åº”ç”¨ç”¨ä¾‹ç¤ºä¾‹
```python
# analysis/application/use_cases/analysis/analysis_use_case.py
class AnalysisUseCase:
    """åˆ†æç”¨ä¾‹"""
    
    def __init__(self, analysis_service: AnalysisService):
        self.analysis_service = analysis_service
    
    async def create_analysis_task(
        self,
        task_data: AnalysisTaskCreateDTO,
        created_by: str
    ) -> Dict[str, Any]:
        """åˆ›å»ºåˆ†æä»»åŠ¡"""
        task = await self.analysis_service.create_analysis_task(
            name=task_data.name,
            analysis_type=task_data.analysis_type,
            parameters=task_data.parameters,
            created_by=created_by,
            description=task_data.description
        )
        
        return {
            "success": True,
            "message": "åˆ†æä»»åŠ¡åˆ›å»ºæˆåŠŸ",
            "data": AnalysisTaskResponseDTO(**task.to_dict())
        }
```

### APIè·¯ç”±ç¤ºä¾‹
```python
# analysis/api/v1/analysis/analysis.py
@router.post("/tasks", response_model=Dict[str, Any])
async def create_analysis_task(
    task_data: AnalysisTaskCreateDTO,
    session = Depends(get_db)
) -> Dict[str, Any]:
    """åˆ›å»ºåˆ†æä»»åŠ¡"""
    try:
        analysis_use_case = build_analysis_use_case(session)
        created_by = "test_user"  # ä»JWT tokenè·å–
        result = await analysis_use_case.create_analysis_task(task_data, created_by)
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail="åˆ›å»ºåˆ†æä»»åŠ¡å¤±è´¥")
```

### åŸºç¡€è®¾æ–½å±‚ç¤ºä¾‹
```python
# analysis/infrastructure/database/postgres/models.py
class AnalysisTaskModel(Base):
    """åˆ†æä»»åŠ¡æ•°æ®åº“æ¨¡å‹"""
    __tablename__ = "analysis_tasks"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    name = Column(String(100), nullable=False, index=True)
    description = Column(Text, nullable=True)
    analysis_type = Column(String(50), nullable=False, index=True)
    parameters = Column(JSONB, nullable=False)
    status = Column(String(20), nullable=False, index=True)
    created_by = Column(String(100), nullable=False, index=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    started_at = Column(DateTime(timezone=True), nullable=True)
    completed_at = Column(DateTime(timezone=True), nullable=True)
    progress = Column(Float, default=0.0, nullable=False)
    
    # SuperMapç›¸å…³å­—æ®µ
    supermap_request = Column(JSONB, nullable=True)
    supermap_result = Column(JSONB, nullable=True)
    error_message = Column(Text, nullable=True)
```

## ä¾èµ–æ³¨å…¥å®¹å™¨

```python
# analysis/core/container.py
def build_analysis_use_case(session) -> AnalysisUseCase:
    """æ„å»ºåˆ†æç”¨ä¾‹"""
    # æ„å»ºä»“å‚¨
    task_repository = AnalysisTaskRepository(session)
    result_repository = AnalysisResultRepository(session)
    spatial_data_repository = SpatialDataRepository(session)
    
    # æ„å»ºé¢†åŸŸæœåŠ¡
    analysis_service = AnalysisService(
        task_repository=task_repository,
        result_repository=result_repository,
        spatial_data_repository=spatial_data_repository
    )
    
    # æ„å»ºç”¨ä¾‹
    return AnalysisUseCase(analysis_service=analysis_service)
```

## å¼€å‘æ£€æŸ¥æ¸…å•

åœ¨å®ç°æ–°åŠŸèƒ½æ—¶ï¼Œå¿…é¡»æ£€æŸ¥ï¼š
- [ ] æ˜¯å¦éµå¾ªåˆ†å±‚æ¶æ„åŸåˆ™
- [ ] æ˜¯å¦åœ¨æ­£ç¡®çš„å±‚æ¬¡å®ç°åŠŸèƒ½
- [ ] æ˜¯å¦ä½¿ç”¨ä¾èµ–æ³¨å…¥
- [ ] æ˜¯å¦å®šä¹‰æ¸…æ™°çš„æ¥å£
- [ ] æ˜¯å¦å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†
- [ ] æ˜¯å¦åŒ…å«å•å…ƒæµ‹è¯•
- [ ] æ˜¯å¦éµå¾ªå‘½åè§„èŒƒ
- [ ] æ˜¯å¦åŒ…å«å®Œæ•´çš„æ–‡æ¡£
