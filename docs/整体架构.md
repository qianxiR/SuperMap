# 后端空间分析服务接口规范

## 服务基础信息
- **服务地址**: `http://localhost:8087`
- **API前缀**: `/api/v1/spatial-analysis`
- **文档地址**: `http://localhost:8087/docs`
- **健康检查**: `http://localhost:8087/health`
- **架构模式**: DDD (Domain-Driven Design)

## 统一API响应格式

所有分析API都使用统一的响应格式，通过`toApiResponse()`方法实现：

```json
{
  "success": true,
  "data": {
    "resultId": "分析结果ID",
    "resultName": "分析结果名称", 
    "features": [...],        // 统一的几何数据字段
    "statistics": {...},      // 统一的统计信息字段
    "metadata": {...},        // 统一的元数据字段
    "executionTime": "执行时间"
  },
  "message": "分析执行成功",
  "timestamp": "时间戳"
}
```

前端统一使用：
```javascript
const features = apiResponse.data.features        // 几何数据
const statistics = apiResponse.data.statistics    // 统计信息  
const resultId = apiResponse.data.resultId        // 结果ID
const resultName = apiResponse.data.resultName    // 结果名称
```

## 1. 缓冲区分析接口

### 请求接口
```
POST /api/v1/spatial-analysis/buffer
Content-Type: application/json
```

### 请求体格式
```json
{
  "sourceData": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point|LineString|Polygon|MultiPoint|MultiLineString|MultiPolygon",
          "coordinates": [经度, 纬度]
        },
        "properties": {
          "id": "要素ID",
          "name": "要素名称"
        }
      }
    ]
  },
  "bufferSettings": {
    "radius": 1000,
    "semicircleLineSegment": 10
  },
  "options": {
    "resultLayerName": "缓冲区分析结果",
    "returnGeometry": true,
    "returnProperties": true
  }
}
```

### 参数说明
- **sourceData**: 源GeoJSON数据（必需）
- **bufferSettings.radius**: 缓冲区半径，单位米（必需）
- **bufferSettings.semicircleLineSegment**: 半圆线段数，默认10（可选）
- **options.resultLayerName**: 结果图层名称（可选）

### 响应格式
```json
{
  "success": true,
  "data": {
    "resultId": "buffer_result_2024-01-01T00:00:00-000Z",
    "resultName": "缓冲区分析结果",
    "sourceLayerName": "源图层名称",
    "bufferSettings": {
      "radius": 1000,
      "unit": "meters",
      "semicircleLineSegment": 10
    },
    "statistics": {
      "inputFeatureCount": 2,
      "outputFeatureCount": 2,
      "totalArea": 6283185.31,
      "areaUnit": "square_meters"
    },
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[经度, 纬度], ...]]
        },
        "properties": {
          "id": "buffer_要素ID_时间戳",
          "name": "要素名称_缓冲区",
          "bufferDistance": 1000,
          "area": 3141592.65
        }
      }
    ],
    "executionTime": "0.123s"
  },
  "message": "缓冲区分析执行成功",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 技术实现要点
- 使用`turf.buffer()`函数执行缓冲区计算
- 支持多种几何类型（点、线、面）
- 自动处理几何体合并和结果优化
- 提供详细的面积统计信息

## 2. 相交分析接口

### 请求接口
```
POST /api/v1/spatial-analysis/intersection
Content-Type: application/json
```

### 请求体格式
```json
{
  "targetData": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point|LineString|Polygon|MultiPoint|MultiLineString|MultiPolygon",
          "coordinates": [经度, 纬度]
        },
        "properties": {
          "id": "目标要素ID",
          "name": "目标要素名称"
        }
      }
    ]
  },
  "maskData": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point|LineString|Polygon|MultiPoint|MultiLineString|MultiPolygon",
          "coordinates": [经度, 纬度]
        },
        "properties": {
          "id": "遮罩要素ID",
          "name": "遮罩要素名称"
        }
      }
    ]
  },
  "analysisOptions": {
    "batchSize": 100,
    "enableProgress": true,
    "returnGeometry": true
  },
  "options": {
    "resultLayerName": "相交分析结果",
    "enableStatistics": true,
    "coordinateSystem": "EPSG:4326"
  }
}
```

### 参数说明
- **targetData**: 目标图层GeoJSON数据（必需）
- **maskData**: 遮罩图层GeoJSON数据（必需）
- **analysisOptions.batchSize**: 批处理大小，默认100（可选）
- **analysisOptions.enableProgress**: 是否启用进度显示，默认true（可选）
- **analysisOptions.returnGeometry**: 是否返回几何数据，默认true（可选）

### 响应格式
```json
{
  "success": true,
  "data": {
    "resultId": "intersection_123",
    "resultName": "相交分析结果",
    "features": [
      {
        "id": "intersection_0_0_1234567890",
        "name": "相交区域 1",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[经度, 纬度], ...]]
        },
        "sourceTargetLayerName": "目标图层",
        "sourceMaskLayerName": "遮罩图层",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "statistics": {
      "totalResults": 1,
      "targetFeatureCount": 1,
      "maskFeatureCount": 1,
      "totalPairs": 1,
      "processingTime": 150,
      "successRate": 100
    },
    "metadata": {
      "version": "1.0.0",
      "algorithm": "turf-intersect",
      "coordinateSystem": "EPSG:4326",
      "batchSize": 100
    }
  },
  "message": "相交分析执行成功",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 技术实现要点
- 使用`turf.intersect()`函数执行相交计算
- 支持异步批处理大量要素组合
- 智能合并遮罩要素提升性能
- 提供详细的处理统计信息

## 3. 擦除分析接口

### 请求接口
```
POST /api/v1/spatial-analysis/erase
Content-Type: application/json
```

### 请求体格式
```json
{
  "targetData": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point|LineString|Polygon|MultiPoint|MultiLineString|MultiPolygon",
          "coordinates": [经度, 纬度]
        },
        "properties": {
          "id": "目标要素ID",
          "name": "目标要素名称"
        }
      }
    ]
  },
  "eraseData": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point|LineString|Polygon|MultiPoint|MultiLineString|MultiPolygon",
          "coordinates": [经度, 纬度]
        },
        "properties": {
          "id": "擦除要素ID",
          "name": "擦除要素名称"
        }
      }
    ]
  },
  "analysisOptions": {
    "batchSize": 100,
    "enableProgress": true,
    "returnGeometry": true
  },
  "options": {
    "resultLayerName": "擦除分析结果",
    "enableStatistics": true,
    "coordinateSystem": "EPSG:4326"
  }
}
```

### 参数说明
- **targetData**: 目标图层GeoJSON数据（必需）
- **eraseData**: 擦除图层GeoJSON数据（必需）
- **analysisOptions**: 分析选项，同相交分析
- **options**: 其他选项，同相交分析

### 响应格式
```json
{
  "success": true,
  "data": {
    "resultId": "erase_123",
    "resultName": "擦除分析结果",
    "features": [
      {
        "id": "erase_0_0_1234567890",
        "name": "擦除区域 1",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[经度, 纬度], ...]]
        },
        "sourceTargetLayerName": "目标图层",
        "sourceEraseLayerName": "擦除图层",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "statistics": {
      "totalResults": 1,
      "targetFeatureCount": 1,
      "eraseFeatureCount": 1,
      "totalPairs": 1,
      "processingTime": 150,
      "successRate": 100
    },
    "metadata": {
      "version": "1.0.0",
      "algorithm": "turf-difference",
      "coordinateSystem": "EPSG:4326",
      "batchSize": 100
    }
  },
  "message": "擦除分析执行成功",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 技术实现要点
- 使用`turf.difference()`函数执行擦除计算
- **性能优化**：从O(N×M)降低到O(N)的计算复杂度
- **智能合并策略**：使用`turf.union()`将多个擦除要素合并为单个`MultiPolygon`
- **容错回退机制**：如果优化方法失败，自动回退到原始方法
- 支持结果几何体合并，简化地图显示

## 4. 最短路径分析接口

### 请求接口
```
POST /api/v1/spatial-analysis/shortest-path
Content-Type: application/json
```

### 请求体格式
```json
{
  "startPoint": {
    "type": "Point",
    "coordinates": [经度, 纬度]
  },
  "endPoint": {
    "type": "Point",
    "coordinates": [经度, 纬度]
  },
  "analysisOptions": {
    "units": "kilometers",
    "resolution": 1000
  },
  "options": {
    "returnGeometry": true,
    "calculateDistance": true,
    "calculateDuration": true,
    "averageSpeed": 50
  },
  "obstacleData": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Point|LineString|Polygon|MultiPoint|MultiLineString|MultiPolygon",
          "coordinates": [经度, 纬度]
        },
        "properties": {
          "id": "障碍物ID",
          "name": "障碍物名称"
        }
      }
    ]
  }
}
```

### 参数说明
- **startPoint**: 起点坐标，GeoJSON Point格式（必需）
- **endPoint**: 终点坐标，GeoJSON Point格式（必需）
- **analysisOptions.units**: 距离单位，默认"kilometers"（可选）
- **analysisOptions.resolution**: 分辨率，默认1000（可选）
- **options.averageSpeed**: 平均速度，单位km/h，默认50（可选）
- **obstacleData**: 障碍物数据，可选

### 响应格式
```json
{
  "success": true,
  "data": {
    "resultId": "shortest_path_result_2024-01-01T00:00:00-000Z",
    "resultName": "最短路径分析结果",
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "LineString",
          "coordinates": [[经度, 纬度], ...]
        },
        "properties": {
          "id": "shortest_path_result_2024-01-01T00:00:00-000Z",
          "name": "最短路径分析结果",
          "analysisType": "shortest-path",
          "createdAt": "2024-01-01T00:00:00.000Z"
        }
      }
    ],
    "statistics": {
      "distance": 12.34,
      "distanceUnit": "kilometers",
      "duration": 14.81,
      "durationUnit": "minutes",
      "complexity": 2,
      "averageSpeed": 50,
      "speedUnit": "km/h"
    },
    "executionTime": "0.123s"
  },
  "message": "最短路径分析执行成功",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 技术实现要点
- 使用`turf.shortestPath()`函数执行路径计算
- 支持障碍物避让算法
- 自动处理不同几何类型的障碍物（点、线、面）
- 提供详细的路径统计信息（距离、时长、复杂度）

## 5. 辅助接口

### 获取分析选项
```
GET /api/v1/spatial-analysis/{analysis-type}/options
```

### 数据验证接口
```
POST /api/v1/spatial-analysis/{analysis-type}/validate
```

### 统计信息接口
```
POST /api/v1/spatial-analysis/{analysis-type}/statistics
```

### 健康检查
```
GET /health
```

### 服务信息
```
GET /
```

## 6. 错误响应格式

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述信息",
    "type": "ErrorType"
  },
  "message": "操作失败"
}
```

## 7. 通用规范

### 坐标系
- 所有坐标使用 **EPSG:4326** 坐标系
- 坐标格式：`[经度, 纬度]`
- 前端自动进行EPSG:3857到EPSG:4326的投影转换

### 支持的几何类型
- Point
- LineString  
- Polygon
- MultiPoint
- MultiLineString
- MultiPolygon

### 数据转换流程
1. **前端**：Openlayers Feature → GeoJSON FeatureCollection
2. **网络传输**：HTTP POST + JSON格式
3. **后端**：GeoJSON → Turf.js Feature → 分析计算 → GeoJSON结果
4. **前端**：GeoJSON结果 → Openlayers Feature → 地图显示

### 请求限制
- 请求体大小限制：10MB
- 请求频率限制：根据配置
- 超时时间：30秒（开发环境），45秒（生产环境）

### 响应头
```
Content-Type: application/json
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
```

## 8. 性能优化特性

### 缓冲区分析
- 支持批量处理大量要素
- 自动几何体合并优化
- 内存管理和垃圾回收

### 相交分析
- 智能合并遮罩要素
- 异步批处理避免阻塞
- 分页渲染大量结果

### 擦除分析
- **算法优化**：从O(N×M)降低到O(N)复杂度
- 智能合并擦除要素和结果几何体
- 容错回退机制确保稳定性

### 最短路径分析
- 障碍物智能处理
- 路径复杂度计算
- 多种距离单位支持

## 9. 架构设计

### DDD分层架构
- **API层**：处理HTTP请求和响应
- **应用层**：用例和DTO管理
- **领域层**：核心业务逻辑和实体
- **基础设施层**：外部依赖和技术实现

### 核心组件
- **geometryConverter.js**：几何数据转换工具
- **turf.js**：空间分析计算引擎
- **统一响应格式**：所有API使用相同的响应结构
- **错误处理**：完整的验证和错误处理机制

## 10. 数据流转过程

### 前端到后端
1. **数据提取**：使用`extractGeoJSONFromlayer`从Openlayers图层提取GeoJSON数据
2. **投影转换**：EPSG:3857 → EPSG:4326
3. **请求构建**：构建标准化的API请求数据
4. **HTTP传输**：POST请求发送到后端API

### 后端处理
1. **数据验证**：DTO层验证请求数据格式
2. **格式转换**：使用`geometryConverter.js`将GeoJSON转换为turf.js格式
3. **分析计算**：调用相应的turf.js函数执行空间分析
4. **结果处理**：格式化分析结果为统一API响应格式

### 后端到前端
1. **响应接收**：前端接收统一的API响应格式
2. **数据提取**：从`features`字段提取几何数据
3. **格式转换**：使用Openlayers GeoJSON格式器转换几何数据
4. **地图显示**：创建图层并在地图上显示分析结果

这就是后端目前期待的所有接口规范，所有接口都遵循统一的请求/响应格式，支持完整的GeoJSON几何类型，使用EPSG:4326坐标系，并具备完整的性能优化和错误处理机制。
