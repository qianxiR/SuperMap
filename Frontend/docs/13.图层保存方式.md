# 图层保存方式

## 概述

本文档描述了前端系统中所有分析功能和选择功能的标准化图层保存方式。所有功能都使用统一的 `saveFeaturesAslayer` 函数进行数据保存，确保数据格式的一致性和原始属性的完整性。

## 通用保存函数

### 函数位置
`Frontend/src/composables/useLayerManager.ts` 中的 `saveFeaturesAslayer` 函数

### 函数签名
```typescript
const saveFeaturesAslayer = async (
  features: any[], 
  layerName: string, 
  sourceType: 'draw' | 'area' | 'query' | 'buffer' | 'path' | 'upload' | 'intersect' | 'erase' = 'draw'
) => Promise<boolean>
```

## 标准属性数据结构

### 基础几何属性
每个保存的要素都包含以下标准几何属性：

**点要素：**
- `elementId`: 要素序号（从1开始）
- `longitude`: 经度（保留6位小数）
- `latitude`: 纬度（保留6位小数）
- `coordinateUnit`: 坐标单位（度）

**线要素：**
- `elementId`: 要素序号（从1开始）
- `length`: 长度（保留3位小数）
- `lengthUnit`: 长度单位（千米）

**面要素：**
- `elementId`: 要素序号（从1开始）
- `area`: 面积（保留3位小数）
- `areaUnit`: 面积单位（平方千米）

### 元数据属性
- `sourceType`: 数据来源类型
- `saveTime`: 保存时间（ISO格式）
- `layerName`: 图层名称
- `saveFormat`: 保存格式（'polygon' 或 'featurecollection'）

## 各功能特定属性

### 缓冲区分析
- `distance`: 缓冲区距离
- `unit`: 距离单位
- `sourcelayer`: 源图层名称
- `createdAt`: 创建时间
- `analysisType`: 'buffer'

### 相交分析
- `sourceTarget`: 目标图层名称
- `sourceMask`: 掩膜图层名称
- `createdAt`: 创建时间
- `analysisType`: 'intersection'

### 擦除分析
- `sourceTarget`: 目标图层名称
- `sourceErase`: 擦除图层名称
- `createdAt`: 创建时间
- `analysisType`: 'erase'

### 最短路径分析
- `distance`: 路径距离
- `duration`: 路径时长
- `pathType`: 路径类型
- `sourcelayerName`: 源图层名称
- `createdAt`: 创建时间
- `analysisType`: 'path'

### 按属性选择
- `analysisType`: 'attribute_query'
- `sourceLayer`: 源图层ID
- `parameters`: 查询条件参数

### 按区域选择
- `analysisType`: 'area_selection'
- `parameters`: 选择参数（包含选择数量等）

## 属性保存优先级

### 属性合并策略
1. **优先保留原始属性**：`...properties` 放在最前面
2. **条件性添加几何属性**：只有当原始属性中不存在该字段时才添加
3. **条件性添加元数据**：只有当原始属性中不存在该字段时才添加

### 实现代码
```javascript
properties: {
  // 优先保留原始属性，避免被覆盖
  ...properties,
  // 几何属性只在原始属性中不存在时才添加
  ...Object.fromEntries(
    Object.entries(geometricProperties).filter(([key]) => !(key in properties))
  ),
  // 元数据属性只在原始属性中不存在时才添加
  ...(properties.sourceType ? {} : { sourceType: sourceType }),
  ...(properties.saveTime ? {} : { saveTime: new Date().toISOString() }),
  ...(properties.layerName ? {} : { layerName: layerName }),
  ...(properties.saveFormat ? {} : { saveFormat: saveFormat })
}
```

## 标准化保存流程

### 1. 数据转换
将分析结果转换为 OpenLayers Feature 格式：
```javascript
const features = results.map(item => {
  const format = new GeoJSON()
  const geometry = format.readGeometry(item.geometry)
  const feature = new Feature({ 
    geometry, 
    properties: { 
      // 保留完整的原始属性数据
      ...item.properties,
      // 添加或覆盖分析元数据
      id: item.properties?.id || item.id, 
      name: item.properties?.name || item.name, 
      // ... 其他分析特定属性
      analysisType: 'analysis_type'
    } 
  })
  return feature
}).filter(Boolean)
```

### 2. 调用通用保存函数
```javascript
const success = await saveFeaturesAslayer(
  features,
  layerName,
  sourceType
)
```

### 3. 自动处理
- 几何属性计算（面积、长度、坐标等）
- 样式应用（根据 sourceType 使用相应主题色）
- 图层管理（添加到图层管理器列表）

## 样式管理

### 主题色系统
所有保存的图层都使用统一的主题色系统：

- **分析类功能**：使用 `--analysis-color` 主题变量（红色）
- **绘制功能**：使用 `--draw-color` 主题变量（红色）
- **上传功能**：使用 `--upload-color` 主题变量（红色）
- **路径分析**：使用固定的蓝色样式

### 样式应用
```javascript
const getlayerStyle = () => {
  const createRedStyle = (type: string, width: number = 2) => {
    const { color, rgb } = getRedColor(type)
    return new ol.style.Style({
      stroke: new ol.style.Stroke({
        color: color,
        width: width
      }),
      fill: new ol.style.Fill({
        color: color + '4D' // 70%透明度
      }),
      image: new ol.style.Circle({
        radius: 6,
        fill: new ol.style.Fill({
          color: color
        }),
        stroke: new ol.style.Stroke({
          color: panelColor,
          width: 2
        })
      })
    })
  }
  
  switch (sourceType) {
    case 'buffer':
    case 'intersect':
    case 'erase':
      return createRedStyle('analysis', 3)
    case 'path':
      return createBlueStyle() // 蓝色样式
    default:
      return createRedStyle('analysis', 2)
  }
}
```

## 数据格式兼容性

### 保存格式
所有功能都支持两种保存格式：

1. **单一多边形**：当只有多边形要素时保存为 `Polygon` 格式
2. **要素集合**：其他情况保存为 `FeatureCollection` 格式

### 格式判断逻辑
```javascript
// 根据要素类型决定保存格式
let saveFormat: 'polygon' | 'featurecollection'
if (geometryTypes.size === 1 && geometryTypes.has('Polygon')) {
  saveFormat = 'polygon'
} else {
  saveFormat = 'featurecollection'
}
```

## 使用示例

### 缓冲区分析保存
```javascript
// 将缓冲区结果转换为 OpenLayers Feature，保留完整属性
const features = bufferResults.value.map((result: any) => {
  const format = new window.ol.format.GeoJSON()
  const geometry = format.readGeometry(result.geometry)
  const feature = new window.ol.Feature({ 
    geometry, 
    properties: { 
      // 保留完整的原始属性数据
      ...(result.properties || {}),
      // 添加或覆盖分析元数据
      id: result.properties?.id || result.id, 
      name: result.properties?.name || result.name, 
      distance: result.distance,
      unit: result.unit,
      sourcelayer: result.sourcelayerName,
      createdAt: result.createdAt,
      analysisType: 'buffer'
    } 
  })
  return feature
})

// 调用通用保存函数
const success = await saveFeaturesAslayer(
  features,
  layerName,
  'buffer'
)
```

### 相交分析保存
```javascript
// 将相交结果转换为 Openlayers Feature，保留完整属性
const features = results.value.map((item: any) => {
  const format = new GeoJSON()
  const geometry = format.readGeometry(item.geometry)
  const feature = new Feature({ 
    geometry, 
    properties: { 
      // 保留完整的原始属性数据
      ...item.properties,
      // 添加或覆盖分析元数据
      id: item.properties?.id || item.id, 
      name: item.properties?.name || item.name, 
      sourceTarget: item.sourceTargetlayerName, 
      sourceMask: item.sourceMasklayerName, 
      createdAt: item.createdAt,
      analysisType: 'intersection'
    } 
  })
  return feature
})

// 调用通用保存函数
await saveFeaturesAslayer(features, customlayerName, 'intersect')
```

## 注意事项

1. **原始属性优先**：始终优先保留输入图层的原始属性数据
2. **元数据补充**：只在原始属性中不存在时才添加元数据字段
3. **类型安全**：使用 `(result.properties || {})` 确保类型安全
4. **统一调用**：所有功能都应使用 `saveFeaturesAslayer` 函数
5. **样式一致性**：根据 `sourceType` 自动应用相应的主题样式

## 相关文件

- `Frontend/src/composables/useLayerManager.ts` - 通用保存函数
- `Frontend/src/views/dashboard/management-analysis/traditional/tools/BufferAnalysisPanel.vue` - 缓冲区分析
- `Frontend/src/views/dashboard/management-analysis/traditional/tools/IntersectionAnalysisPanel.vue` - 相交分析
- `Frontend/src/views/dashboard/management-analysis/traditional/tools/EraseAnalysisPanel.vue` - 擦除分析
- `Frontend/src/composables/useShortestPathAnalysis.ts` - 最短路径分析
- `Frontend/src/views/dashboard/management-analysis/traditional/tools/FeatureQueryPanel.vue` - 按属性选择
- `Frontend/src/views/dashboard/management-analysis/traditional/tools/AreaSelectionTools.vue` - 按区域选择
