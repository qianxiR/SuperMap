# SuperMap æ•°æ®è¯»å–æµç¨‹æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†å‰ç«¯ç³»ç»Ÿå¦‚ä½•ä» SuperMap iServer æœåŠ¡è¯»å–åœ°ç†æ•°æ®çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬é…ç½®ç®¡ç†ã€æ•°æ®åŠ è½½ã€å›¾å±‚æ¸²æŸ“ç­‰å„ä¸ªç¯èŠ‚ã€‚

## 1. ç³»ç»Ÿæ¶æ„

### 1.1 æ¨¡å—åŒ–æ¶æ„è®¾è®¡

ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†æ•°æ®è¯»å–ç›¸å…³åŠŸèƒ½æ‹†åˆ†ä¸ºä»¥ä¸‹æ¨¡å—ï¼š

```
useMap.ts (ä¸»å…¥å£)
â”œâ”€â”€ useMapStyles.ts    - æ ·å¼ç®¡ç†
â”œâ”€â”€ useMapData.ts      - æ•°æ®åŠ è½½ â­æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ useMapInteraction.ts - ç”¨æˆ·äº¤äº’
â””â”€â”€ useMapLifecycle.ts - ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

### 1.2 æ•°æ®æµå‘å›¾

```mermaid
graph TD
    A[ç”¨æˆ·è®¿é—®] --> B[åœ°å›¾åˆå§‹åŒ–]
    B --> C[é…ç½®åŠ è½½]
    C --> D[æœåŠ¡å¥åº·æ£€æŸ¥]
    D --> E[å›¾å±‚é…ç½®è¯»å–]
    E --> F{å›¾å±‚ç±»å‹åˆ¤æ–­}
    F -->|ç«‹å³åŠ è½½| G[ç›´æ¥æ•°æ®è·å–]
    F -->|æ‡’åŠ è½½| H[åˆ›å»ºç©ºå®¹å™¨]
    G --> I[SuperMap APIè°ƒç”¨]
    H --> J[ç”¨æˆ·ç‚¹å‡»æ˜¾ç¤º]
    J --> I
    I --> K[æ•°æ®è½¬æ¢]
    K --> L[å›¾å±‚æ¸²æŸ“]
    L --> M[ç”¨æˆ·äº¤äº’]
```

## 2. é…ç½®ç³»ç»Ÿ

### 2.1 ç¯å¢ƒå˜é‡é…ç½®

ç³»ç»Ÿé€šè¿‡ç¯å¢ƒå˜é‡åŠ¨æ€é…ç½® SuperMap æœåŠ¡è¿æ¥å‚æ•°ï¼š

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|---------|------|--------|
| `VITE_SUPERMAP_BASE_URL` | æœåŠ¡å™¨åŸºç¡€åœ°å€ | `http://localhost:8090` |
| `VITE_SUPERMAP_DATA_SERVICE` | æ•°æ®æœåŠ¡è·¯å¾„ | `iserver/services/data-xxx/rest/data` |
| `VITE_SUPERMAP_MAP_SERVICE` | åœ°å›¾æœåŠ¡è·¯å¾„ | `iserver/services/map-xxx/rest` |
| `VITE_SUPERMAP_WORKSPACE` | å·¥ä½œç©ºé—´åç§° | `workspace_name` |
| `VITE_SUPERMAP_MAP_EXTENT` | åœ°å›¾è¾¹ç•ŒèŒƒå›´ | `[minX,minY,maxX,maxY]` |

### 2.2 å›¾å±‚é…ç½®ç»“æ„

```typescript
interface LayerConfig {
  name: string;          // å›¾å±‚åç§°ï¼Œæ ¼å¼ï¼šæ•°æ®é›†@æ•°æ®æº@@å·¥ä½œç©ºé—´
  type: string;          // å‡ ä½•ç±»å‹ï¼špoint/line/polygon
  visible: boolean;      // åˆå§‹å¯è§æ€§
  lazyLoad: boolean;     // æ˜¯å¦æ‡’åŠ è½½
  zIndex?: number;       // å›¾å±‚å±‚çº§
}
```

## 3. æ•°æ®è¯»å–æ ¸å¿ƒæµç¨‹

### 3.1 å›¾å±‚åŠ è½½æ€»æµç¨‹

```typescript
// æ–‡ä»¶ä½ç½®ï¼šsrc/composables/useMapData.ts
const loadVectorLayers = async (map: any): Promise<void> => {
  const apiConfig = createAPIConfig()
  
  for (const layerConfig of apiConfig.wuhanlayers) {
    const layerName = layerConfig.name.split('@')[0]
    
    // ğŸ” é‡å¤æ£€æŸ¥æœºåˆ¶
    const existingLayer = mapStore.vectorlayers.find(l => 
      l.id === layerConfig.name || l.name === layerName
    )
    
    if (existingLayer) {
      console.log(`å›¾å±‚ ${layerName} å·²å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½`)
      continue
    }
    
    // ğŸ“‹ åŠ è½½ç­–ç•¥åˆ¤æ–­
    const shouldLoadImmediately = !layerConfig.lazyLoad && layerConfig.visible
    
    if (shouldLoadImmediately) {
      // ğŸš€ ç«‹å³åŠ è½½
      loadTasks.push(loadVectorLayer(map, layerConfig, true))
    } else {
      // ğŸ’¤ æ‡’åŠ è½½ï¼šåˆ›å»ºç©ºå®¹å™¨
      createLazyLayerContainer(map, layerConfig)
    }
  }
}
```

### 3.2 å•ä¸ªå›¾å±‚æ•°æ®è·å–è¯¦ç»†æµç¨‹

#### æ­¥éª¤1ï¼šå›¾å±‚åç§°è§£æ
```typescript
// è§£æå›¾å±‚åç§°æ ¼å¼ï¼šæ­¦æ±‰_å¿çº§@wuhan@@workspace
const parts = layerConfig.name.split('@');
const dataset = parts[0];    // æ•°æ®é›†åç§°ï¼šæ­¦æ±‰_å¿çº§
const datasource = parts[1]; // æ•°æ®æºåç§°ï¼šwuhan
const workspace = parts[2];  // å·¥ä½œç©ºé—´åç§°ï¼šworkspace
```

#### æ­¥éª¤2ï¼šè·å–å…ƒæ•°æ®ä¿¡æ¯
```typescript
// HTTP GET è¯·æ±‚è·å–å›¾å±‚å…ƒæ•°æ®
const metaUrl = `${dataUrl}/datasources/${datasource}/datasets/${dataset}/features.json`;
const metaResponse = await fetch(metaUrl);
const metadata = await metaResponse.json();

// è§£æå…ƒæ•°æ®
const startIndex = metadata.startIndex || 0;
const featureCount = metadata.featureCount || 20;
const totalFeatures = startIndex + featureCount - 1;
```

#### æ­¥éª¤3ï¼šç©ºé—´è¾¹ç•Œè®¾ç½®
```typescript
// ä»é…ç½®ä¸­è·å–åœ°å›¾è¾¹ç•Œï¼Œç”¨äºç©ºé—´è¿‡æ»¤
const mapExtent = apiConfig.mapBounds.extent;
const mapBounds = new ol.geom.Polygon([[
  [mapExtent[0], mapExtent[1]], // å·¦ä¸‹è§’
  [mapExtent[2], mapExtent[1]], // å³ä¸‹è§’
  [mapExtent[2], mapExtent[3]], // å³ä¸Šè§’
  [mapExtent[0], mapExtent[3]], // å·¦ä¸Šè§’
  [mapExtent[0], mapExtent[1]]  // é—­åˆ
]]);
```

#### æ­¥éª¤4ï¼šé¦–é¡µæ•°æ®è·å–
```typescript
// ä½¿ç”¨ SuperMap FeatureService è·å–è¦ç´ æ•°æ®
const featureService = new ol.supermap.FeatureService(dataUrl);

const params = new ol.supermap.GetFeaturesByBoundsParameters({
  datasetNames: [`${datasource}:${dataset}`],
  bounds: ol.extent.boundingExtent(mapBounds.getCoordinates()[0]),
  returnContent: true,
  returnFeaturesOnly: true, // â­ æ€§èƒ½ä¼˜åŒ–ï¼šåªè¿”å›è¦ç´ æ•°æ®
  maxFeatures: -1,
  fromIndex: startIndex,
  toIndex: Math.min(startIndex + 10000 - 1, totalFeatures)
});

featureService.getFeaturesByBounds(params, (result) => {
  if (result.result?.features) {
    // ğŸ”„ GeoJSON è½¬ OpenLayers è¦ç´ 
    const features = new ol.format.GeoJSON().readFeatures(result.result.features);
    vectorLayer.getSource().addFeatures(features);
    
    // ğŸ”„ å¯åŠ¨åˆ†é¡µåŠ è½½
    startPaginationLoad(startIndex + 10000, totalFeatures);
  }
});
```

#### æ­¥éª¤5ï¼šåˆ†é¡µåŠ è½½æœºåˆ¶
```typescript
const startPaginationLoad = (startFrom: number, totalCount: number) => {
  setTimeout(async () => {
    const pageSize = 10000;
    
    for (let start = startFrom; start <= totalCount; start += pageSize) {
      const end = Math.min(start + pageSize - 1, totalCount);
      
      // ğŸ“„ åˆ†é¡µè¯·æ±‚
      await loadPageData(start, end);
    }
  }, 100); // å»¶è¿Ÿ100msï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
};
```

## 4. æ‡’åŠ è½½æœºåˆ¶

### 4.1 æ‡’åŠ è½½å®¹å™¨åˆ›å»º
```typescript
const createLazyLayerContainer = (map: any, layerConfig: any): void => {
  // ğŸ¨ åˆ›å»ºæ ·å¼
  const style = createLayerStyle(layerConfig, layerName);
  
  // ğŸ“¦ åˆ›å»ºç©ºå®¹å™¨
  const vectorLayer = new ol.layer.Vector({
    source: new ol.source.Vector({}), // ç©ºæ•°æ®æº
    style: style,
    visible: layerConfig.visible
  });
  
  // ğŸ·ï¸ è®¾ç½®æ ‡è¯†
  vectorLayer.set('isLazyLoaded', true);
  vectorLayer.set('isLoaded', false);
  
  // ğŸ’¾ å­˜å‚¨åˆ°çŠ¶æ€ç®¡ç†
  mapStore.vectorlayers.push({
    id: layerName,
    name: layerName,
    layer: vectorLayer,
    visible: layerConfig.visible,
    isLazyLoaded: true,
    isLoaded: false
  });
};
```

### 4.2 æŒ‰éœ€æ•°æ®åŠ è½½
```typescript
const loadLazyLayer = async (layerName: string): Promise<boolean> => {
  const layerInfo = mapStore.vectorlayers.find(l => 
    l.name === layerName && l.isLazyLoaded
  );
  
  if (layerInfo?.isLoaded) {
    return true; // å·²åŠ è½½ï¼Œç›´æ¥è¿”å›
  }
  
  // ğŸš€ æ‰§è¡Œå®é™…æ•°æ®åŠ è½½
  const layerConfig = layerInfo.layer.get('layerConfig');
  await loadVectorLayer(mapStore.map, layerConfig, true);
  
  // âœ… æ›´æ–°åŠ è½½çŠ¶æ€
  layerInfo.isLoaded = true;
  layerInfo.layer.set('isLoaded', true);
  
  return true;
};
```

### 4.3 å†…å­˜ç®¡ç† - æ•°æ®å¸è½½
```typescript
const unloadLazyLayer = async (layerName: string): Promise<boolean> => {
  const layerInfo = mapStore.vectorlayers.find(l => 
    l.name === layerName && l.isLazyLoaded
  );
  
  if (!layerInfo?.isLoaded) {
    return true; // æœªåŠ è½½ï¼Œæ— éœ€å¸è½½
  }
  
  // ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®æº
  const source = layerInfo.layer.getSource();
  if (source) {
    source.clear();
  }
  
  // ğŸ‘ï¸ éšè—å›¾å±‚
  layerInfo.layer.setVisible(false);
  
  // ğŸ“Š æ›´æ–°çŠ¶æ€
  layerInfo.isLoaded = false;
  layerInfo.layer.set('isLoaded', false);
  
  return true;
};
```

## 5. æ•°æ®æ ¼å¼ä¸è½¬æ¢

### 5.1 SuperMap è¿”å›çš„æ•°æ®æ ¼å¼
```json
{
  "result": {
    "features": [
      {
        "type": "Feature",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[114.1, 30.5], [114.2, 30.5], ...]]
        },
        "properties": {
          "SMID": 1,
          "SMUSERID": 0,
          "SMAREA": 2247036621.6979637,
          "SMPERIMETER": 277043.97961264406,
          "PAC_1": 420116,
          "NAME_1": "é»„é™‚åŒº",
          "geometryType": "REGION"
        }
      }
    ],
    "totalCount": 247,
    "currentCount": 20
  }
}
```

### 5.2 æ•°æ®è½¬æ¢è¿‡ç¨‹
```typescript
// ğŸ”„ GeoJSON è½¬ OpenLayers è¦ç´ 
const features = new ol.format.GeoJSON().readFeatures(serviceResult.result.features);

// ğŸ“Š è¦ç´ å±æ€§è®¿é—®
const properties = feature.getProperties();
// properties åŒ…å«æ‰€æœ‰ SuperMap å­—æ®µï¼š
// - SMID: SuperMap å†…éƒ¨ID
// - SMUSERID: ç”¨æˆ·ID  
// - SMAREA: é¢ç§¯ï¼ˆå¹³æ–¹ç±³ï¼‰
// - SMPERIMETER: å‘¨é•¿ï¼ˆç±³ï¼‰
// - è‡ªå®šä¹‰å­—æ®µ: PAC_1, NAME_1 ç­‰
```

## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 å…¨å±€æ¸…ç†æœºåˆ¶ï¼ˆâœ… æœ€æ–°ä¼˜åŒ–ï¼‰
```typescript
// ğŸš€ ä¸»åŠ¨æ¸…ç†ç­–ç•¥ï¼šåœ¨åœ°å›¾åˆå§‹åŒ–å‰å½»åº•æ¸…ç©ºæ‰€æœ‰æ•°æ®
const clearAllStatesAndLayers = (): void => {
  console.log('=== å¼€å§‹å…¨å±€çŠ¶æ€å’Œå›¾å±‚æ¸…ç† ===')
  
  // 1. æ¸…ç†å›¾å±‚æ•°æ®ï¼ˆSuperMapæœåŠ¡å›¾å±‚ + æœ¬åœ°å›¾å±‚ï¼‰
  mapData.clearAllLayersBeforeInit()
  
  // 2. æ¸…ç†é€‰æ‹©çŠ¶æ€
  selectionStore.clearSelection()
  
  // 3. æ¸…ç†åˆ†æçŠ¶æ€
  analysisStore.closeTool()
  analysisStore.setDrawMode('')
  
  // 4. æ¸…ç†æœ€çŸ­è·¯å¾„åˆ†æçŠ¶æ€
  shortestPathStore.clearAll()
  
  // 5. æ¸…ç†åœ°å›¾é‡æµ‹çŠ¶æ€
  if (mapStore.distanceMeasureMode) {
    mapStore.clearDistanceMeasure()
  }
  if (mapStore.areaMeasureMode) {
    mapStore.clearAreaMeasure()
  }
}
```

### 6.2 å›¾å±‚æ•°æ®æ¸…ç†è¯¦æƒ…
```typescript
const clearAllLayersBeforeInit = (): void => {
  // ç»Ÿè®¡æ¸…ç†ä¿¡æ¯
  const supermapLayersCount = mapStore.vectorlayers.filter(l => l.source === 'supermap').length
  const localLayersCount = mapStore.vectorlayers.filter(l => l.source === 'local').length
  const customLayersCount = mapStore.customlayers.length
  
  // ä»åœ°å›¾ä¸­ç§»é™¤æ‰€æœ‰å›¾å±‚
  if (mapStore.map) {
    mapStore.vectorlayers.forEach(item => {
      try { 
        mapStore.map.removeLayer(item.layer)
      } catch (_) { /* é™é»˜å¤„ç† */ }
    })
    
    mapStore.customlayers.forEach(item => {
      try { 
        mapStore.map.removeLayer(item.layer)
      } catch (_) { /* é™é»˜å¤„ç† */ }
    })
  }
  
  // æ¸…ç©ºæ•°ç»„
  mapStore.vectorlayers.length = 0
  mapStore.customlayers.length = 0
  
  // æ¸…ç©ºé€‰æ‹©å›¾å±‚æ•°æ®æº
  if (mapStore.selectlayer?.getSource) {
    mapStore.selectlayer.getSource().clear()
  }
}
```

### 6.3 åˆ†é¡µåŠ è½½ç­–ç•¥
- **é¡µé¢å¤§å°**: 10,000 ä¸ªè¦ç´ /é¡µ
- **å»¶è¿ŸåŠ è½½**: é¦–é¡µåŠ è½½åå»¶è¿Ÿ 100ms å¼€å§‹åˆ†é¡µ
- **å¼‚æ­¥å¤„ç†**: ä¸é˜»å¡ä¸»çº¿ç¨‹
- **é”™è¯¯å¤„ç†**: é™é»˜å¤„ç†åˆ†é¡µé”™è¯¯

### 6.4 ç©ºé—´è¿‡æ»¤ä¼˜åŒ–
- ä½¿ç”¨é…ç½®çš„åœ°å›¾è¾¹ç•Œè¿›è¡Œç©ºé—´è¿‡æ»¤
- å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“
- æå‡åŠ è½½é€Ÿåº¦

### 6.5 å†…å­˜ç®¡ç†
- æ‡’åŠ è½½å›¾å±‚æ”¯æŒæ•°æ®å¸è½½
- é‡Šæ”¾ä¸éœ€è¦çš„è¦ç´ æ•°æ®
- ä¿ç•™å›¾å±‚å®¹å™¨ç»“æ„

## 7. é”™è¯¯å¤„ç†ä¸ç›‘æ§

### 7.1 æœåŠ¡å¥åº·æ£€æŸ¥
```typescript
const healthCheck = await superMapClient.checkServiceHealth();
if (!healthCheck.success) {
  throw new Error(`SuperMapæœåŠ¡ä¸å¯ç”¨: ${healthCheck.error}`);
}
```

### 7.2 åŠ è½½çŠ¶æ€é€šçŸ¥
```typescript
notificationManager.info(
  `å›¾å±‚ ${layerName} åŠ è½½å®Œæˆ`,
  `å…± ${features.length} ä¸ªè¦ç´ \n` +
  `æ•°æ®æ¥æº: SuperMap iServer\n` +
  `æœåŠ¡å™¨åœ°å€: ${mapStore.mapConfig.dataUrl}`
);
```

## 8. API æ¥å£è¯´æ˜

### 8.1 SuperMap REST API ä½¿ç”¨

#### è·å–è¦ç´ é›†åˆä¿¡æ¯
```
GET {serverUrl}/datasources/{datasourceName}/datasets/{datasetName}/features.json
```

#### æŒ‰è¾¹ç•Œè·å–è¦ç´ 
```
POST {serverUrl}/featureResults.json
Content-Type: application/json

{
  "datasetNames": ["datasource:dataset"],
  "getFeatureMode": "BOUNDS",
  "bounds": {...},
  "returnContent": true,
  "returnFeaturesOnly": true
}
```

### 8.2 ä¸»è¦æ–¹æ³•è¯´æ˜

| æ–¹æ³•å | åŠŸèƒ½ | å‚æ•° | è¿”å›å€¼ |
|--------|------|------|--------|
| `loadVectorLayers()` | åŠ è½½æ‰€æœ‰çŸ¢é‡å›¾å±‚ | `map: ol.Map` | `Promise<void>` |
| `loadVectorLayer()` | åŠ è½½å•ä¸ªå›¾å±‚ | `map, layerConfig, visible?` | `Promise<void>` |
| `loadLazyLayer()` | åŠ è½½æ‡’åŠ è½½å›¾å±‚æ•°æ® | `layerName: string` | `Promise<boolean>` |
| `unloadLazyLayer()` | å¸è½½æ‡’åŠ è½½å›¾å±‚æ•°æ® | `layerName: string` | `Promise<boolean>` |

## 9. è°ƒè¯•ä¸æ•…éšœæ’é™¤

### 9.1 å¸¸è§é—®é¢˜

**é—®é¢˜1**: å›¾å±‚é‡å¤åŠ è½½
- **åŸå› **: é¡µé¢åˆ·æ–°æ—¶æœªæ£€æŸ¥å·²å­˜åœ¨å›¾å±‚
- **è§£å†³**: å·²å®ç°é‡å¤æ£€æŸ¥æœºåˆ¶

**é—®é¢˜2**: åŠ è½½æ€§èƒ½æ…¢
- **åŸå› **: å¤§æ•°æ®é‡åŒæ­¥åŠ è½½
- **è§£å†³**: å®ç°åˆ†é¡µåŠ è½½å’Œæ‡’åŠ è½½

**é—®é¢˜3**: å†…å­˜å ç”¨è¿‡é«˜
- **åŸå› **: æ‰€æœ‰å›¾å±‚æ•°æ®å¸¸é©»å†…å­˜
- **è§£å†³**: å®ç°æ‡’åŠ è½½æ•°æ®å¸è½½

### 9.2 è°ƒè¯•æ—¥å¿—
ç³»ç»Ÿæä¾›è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ï¼š
- å›¾å±‚åŠ è½½çŠ¶æ€
- æ•°æ®è·å–è¿›åº¦  
- é”™è¯¯ä¿¡æ¯è®°å½•
- æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯

## 10. æ€»ç»“

SuperMap æ•°æ®è¯»å–ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œæ”¯æŒå¤šç§åŠ è½½ç­–ç•¥ï¼Œå…·å¤‡å®Œå–„çš„æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚é€šè¿‡é…ç½®åŒ–ç®¡ç†ã€æ‡’åŠ è½½æœºåˆ¶å’Œåˆ†é¡µåŠ è½½ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š
- âœ… **æ¨¡å—åŒ–è®¾è®¡**: èŒè´£æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤
- âœ… **æ‡’åŠ è½½æœºåˆ¶**: æŒ‰éœ€åŠ è½½ï¼ŒèŠ‚çœèµ„æº
- âœ… **åˆ†é¡µåŠ è½½**: å¤§æ•°æ®é›†å‹å¥½
- âœ… **é‡å¤æ£€æŸ¥**: é¿å…èµ„æºæµªè´¹
- âœ… **é”™è¯¯å¤„ç†**: å¥å£®çš„å¼‚å¸¸å¤„ç†
- âœ… **æ€§èƒ½ç›‘æ§**: å®Œæ•´çš„åŠ è½½ç»Ÿè®¡
