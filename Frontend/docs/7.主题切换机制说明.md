# 主题切换机制说明

## 概述

本项目采用优化的主题切换机制，支持浅色和深色两种主题模式，确保地图、UI组件和容器在主题切换时完全同步，无闪烁现象。

## 核心文件结构

```
Frontend/src/
├── composables/
│   └── useThemeOptimization.ts    # 主题切换核心逻辑
├── stores/
│   └── themeStore.ts              # 主题状态管理
├── styles/
│   └── theme.css                  # 主题样式定义
└── composables/
    └── useMap.ts                  # 地图主题同步
```

## 主题切换流程

### 1. 主题切换触发
```typescript
// 用户点击主题切换按钮
const { optimizedToggleTheme } = useThemeOptimization()
await optimizedToggleTheme()
```

### 2. 同步更新机制
```typescript
// 1. 批量更新CSS变量
Object.entries(newThemeVars).forEach(([key, value]) => {
  root.style.setProperty(key, value)
})

// 2. 同步更新data-theme属性
root.setAttribute('data-theme', newTheme)

// 3. 同步更新store状态
themeStore.setTheme(newTheme)

// 4. 立即触发地图主题更新事件
window.dispatchEvent(new CustomEvent('themeChanged', {
  detail: { theme: newTheme }
}))
```

### 3. 地图主题同步
```typescript
// 监听主题变化事件
window.addEventListener('themeChanged', handleThemeChange)

const handleThemeChange = async (event: Event) => {
  const customEvent = event as CustomEvent
  const newTheme = customEvent.detail.theme
  
  // 立即更新底图和矢量图层样式
  await updateBaseMap(newTheme)
  await updatelayerStyles()
}
```

## 主题变量定义

### 浅色主题变量
```css
:root {
  --bg: #f8f9fa;
  --panel: #f9f9f9;
  --border: #dee2e6;
  --text: #212529;
  --accent: #0078D4;
  --map-highlight-color: #0078D4;
  --draw-color: #0078D4;
  --analysis-color: #0078D4;
  --upload-color: #212529;
}
```

### 深色主题变量
```css
[data-theme="dark"] {
  --bg: #1e1e1e;
  --panel: #262626;
  --border: #3c3c3c;
  --text: #ffffff;
  --accent: #0078D4;
  --map-highlight-color: #ffffff;
  --draw-color: #0078D4;
  --analysis-color: #0078D4;
  --upload-color: #ffffff;
}
```

## 防闪烁机制

### 1. 全局防闪烁CSS
```css
/* 全局防闪烁样式 */
*,
*::before,
*::after {
  transition: none !important;
  animation: none !important;
}

/* 地图相关元素防闪烁 */
.ol-viewport,
.ol-canvas,
.ol-control,
.ol-layer,
.ol-tile {
  transition: none !important;
  animation: none !important;
}
```

### 2. 底图预加载机制
```typescript
// 预加载两套主题的底图数据
const preloadBaseMapData = async (): Promise<void> => {
  const lightSource = new ol.source.TileSuperMapRest({
    url: lightBaseMapUrl,
    serverType: 'iserver',
    crossOrigin: 'anonymous'
  })
  
  const darkSource = new ol.source.TileSuperMapRest({
    url: darkBaseMapUrl,
    serverType: 'iserver'
  })
  
  mapStore.setPreloadedBaseMapSources({
    light: lightSource,
    dark: darkSource
  })
}
```

### 3. 图层样式同步更新
```typescript
const updatelayerStyles = async () => {
  // 获取当前主题的CSS变量，避免重复获取
  const css = getComputedStyle(document.documentElement)
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light'
  
  // 批量更新所有图层样式
  const updatePromises: Promise<void>[] = []
  
  mapStore.vectorlayers.forEach(layerInfo => {
    if (layerInfo.layer) {
      const updatePromise = new Promise<void>(resolve => {
        requestAnimationFrame(() => {
          // 更新图层样式
          const newStyle = createlayerStyle(layerConfig, layerInfo.name)
          layerInfo.layer.setStyle(newStyle)
          resolve()
        })
      })
      updatePromises.push(updatePromise)
    }
  })
  
  await Promise.all(updatePromises)
}
```

## 关键优化点

### 1. 移除预渲染容器
- 不再创建隐藏的DOM容器
- 直接使用同步的主题切换方式
- 避免不必要的DOM操作

### 2. 事件驱动同步
- 使用自定义事件`themeChanged`确保地图与UI同步
- 移除防抖机制，实现即时响应
- 保证所有组件同时切换

### 3. 预加载底图源
- 启动时预加载两套主题的底图数据
- 切换时直接使用预加载的源，避免重新请求
- 减少网络延迟和闪烁

### 4. 批量样式更新
- 一次性获取CSS变量，避免重复计算
- 使用Promise.all并行更新所有图层
- 减少重绘次数

## 使用方式

### 1. 在组件中使用主题切换
```vue
<template>
  <button @click="toggleTheme">
    {{ themeStore.theme === 'light' ? '深色模式' : '浅色模式' }}
  </button>
</template>

<script setup>
import { useThemeOptimization } from '@/composables/useThemeOptimization'
import { useThemeStore } from '@/stores/themeStore'

const { optimizedToggleTheme } = useThemeOptimization()
const themeStore = useThemeStore()

const toggleTheme = async () => {
  await optimizedToggleTheme()
}
</script>
```

### 2. 在样式中使用主题变量
```css
.my-component {
  background: var(--bg);
  color: var(--text);
  border: 1px solid var(--border);
}

.my-button {
  background: var(--btn-primary-bg);
  color: var(--btn-primary-color);
}
```

## 性能特点

- **零闪烁**：通过防闪烁CSS和同步更新机制
- **高性能**：预加载底图，减少网络请求
- **即时响应**：事件驱动，无延迟切换
- **内存优化**：移除预渲染容器，减少DOM操作

## 扩展性

该主题切换机制支持：
- 添加新的主题变量
- 扩展更多主题模式
- 自定义主题切换动画
- 集成系统主题检测

## 注意事项

1. 所有使用主题色的组件都应使用CSS变量
2. 新增图层样式时需考虑主题适配
3. 避免在主题切换过程中进行其他DOM操作
4. 确保所有异步操作在主题切换完成后执行
