# 前端项目配置设置管理

## 概述

本文档详细说明前端项目的配置设置管理方式，包括环境变量配置、主题配置、API服务配置、地图配置等各个方面的设置方法和管理机制。

## 1. 配置架构设计

### 1.1 配置分层结构

前端项目采用分层配置架构，将不同类型的配置分离管理：

```
配置层级
├── 环境变量配置 (VITE_*)
│   ├── SuperMap服务配置
│   ├── API服务配置
│   └── 应用基础配置
├── 主题配置系统
│   ├── CSS变量定义
│   ├── 主题状态管理
│   └── 动态主题切换
├── 地图配置管理
│   ├── 图层配置
│   ├── 底图配置
│   └── 显示参数配置
└── 路由配置管理
    ├── 页面路由定义
    ├── 权限控制配置
    └── 元数据配置
```

### 1.2 配置管理原则

- **集中管理**：所有配置通过专门的配置文件集中管理
- **环境分离**：开发、测试、生产环境配置分离
- **动态加载**：支持运行时动态配置更新
- **类型安全**：使用TypeScript确保配置类型安全
- **主题统一**：通过CSS变量实现主题统一管理

## 2. 环境变量配置

### 2.1 SuperMap服务配置

通过环境变量配置SuperMap iServer服务连接参数：

| 环境变量 | 说明 | 示例值 |
|---------|------|--------|
| `VITE_SUPERMAP_BASE_URL` | 服务器基础地址 | `http://localhost:8090` |
| `VITE_SUPERMAP_MAP_SERVICE` | 地图服务路径 | `iserver/services/map-xxx/rest` |
| `VITE_SUPERMAP_DATA_SERVICE` | 数据服务路径 | `iserver/services/data-xxx/rest/data` |
| `VITE_SUPERMAP_WORKSPACE` | 工作空间名称 | `workspace_name` |
| `VITE_SUPERMAP_MAP_NAME` | 地图名称 | `map_name` |
| `VITE_SUPERMAP_DATASET_NAME` | 数据集名称 | `dataset_name` |
| `VITE_SUPERMAP_MAP_EXTENT` | 地图边界范围 | `114.0,30.0,115.0,31.0` |
| `VITE_SUPERMAP_MAP_CENTER` | 地图中心点 | `114.5,30.5` |
| `VITE_SUPERMAP_MAP_ZOOM` | 初始缩放级别 | `10` |
| `VITE_SUPERMAP_BASEMAP_LIGHT` | 浅色主题底图URL | `http://localhost:8090/...` |
| `VITE_SUPERMAP_BASEMAP_DARK` | 深色主题底图URL | `http://localhost:8090/...` |
| `VITE_SUPERMAP_FALLBACK_BASEMAP_LIGHT` | 备用浅色底图URL | `http://localhost:8090/...` |
| `VITE_SUPERMAP_FALLBACK_BASEMAP_DARK` | 备用深色底图URL | `http://localhost:8090/...` |

### 2.2 API服务配置

用户服务和分析服务的环境配置：

| 环境变量 | 说明 | 开发环境 | 生产环境 |
|---------|------|----------|----------|
| `VITE_API_KEY` | API密钥 | - | `your-api-key` |
| `VITE_ANALYSIS_API_KEY` | 分析服务API密钥 | - | `your-analysis-key` |
| `VITE_API_TIMEOUT` | API超时时间(ms) | `10000` | `15000` |
| `VITE_API_RETRY_COUNT` | API重试次数 | `3` | `3` |
| `VITE_DEV_MODE` | 开发模式标识 | `true` | `false` |

### 2.3 配置加载机制

```typescript
// src/utils/config.ts - SuperMap配置管理器
export const createAPIConfig = (): APIConfig => {
  const baseUrl = import.meta.env.VITE_SUPERMAP_BASE_URL
  const mapService = import.meta.env.VITE_SUPERMAP_MAP_SERVICE
  const dataService = import.meta.env.VITE_SUPERMAP_DATA_SERVICE
  
  return {
    baseUrl: baseUrl.replace(/\/$/, ''),
    mapService,
    dataService,
    datasetName: import.meta.env.VITE_SUPERMAP_DATASET_NAME,
    baseMaps: {
      light: import.meta.env.VITE_SUPERMAP_BASEMAP_LIGHT,
      dark: import.meta.env.VITE_SUPERMAP_BASEMAP_DARK
    },
    fallbackBaseMaps: {
      light: import.meta.env.VITE_SUPERMAP_FALLBACK_BASEMAP_LIGHT,
      dark: import.meta.env.VITE_SUPERMAP_FALLBACK_BASEMAP_DARK
    },
    mapBounds: {
      extent: import.meta.env.VITE_SUPERMAP_MAP_EXTENT.split(',').map(Number),
      center: import.meta.env.VITE_SUPERMAP_MAP_CENTER.split(',').map(Number),
      zoom: Number(import.meta.env.VITE_SUPERMAP_MAP_ZOOM)
    }
  }
}
```

## 3. 主题配置系统

### 3.1 CSS变量定义

主题系统通过CSS变量实现颜色和样式的统一管理：

```css
/* src/styles/theme.css */
:root {
  /* 基础颜色 */
  --bg: #f8f9fa;
  --panel: #f9f9f9;
  --border: #dee2e6;
  --text: #212529;
  --accent: #0078D4;
  
  /* 地图相关颜色 */
  --map-hover-fill: rgba(0, 0, 0, 0.06);
  --map-select-fill: rgba(0, 0, 0, 0.15);
  --draw-color: #0078D4;
  --analysis-color: #0078D4;
  --upload-color: #212529;
  
  /* 图层颜色配置 */
  --layer-stroke-武汉_县级: #2c3e50;
  --layer-fill-武汉_县级: rgba(44, 62, 80, 0.05);
  --layer-stroke-公路: #e67e22;
  --layer-fill-公路: rgba(230, 126, 34, 0.12);
}

/* 深色主题 */
[data-theme="dark"] {
  --bg: #1e1e1e;
  --panel: #262626;
  --border: #3c3c3c;
  --text: #ffffff;
  --accent: #0078D4;
  
  /* 深色主题下的地图颜色 */
  --map-hover-fill: rgba(255, 255, 255, 0.06);
  --map-select-fill: rgba(255, 255, 255, 0.15);
  --draw-color: #0078D4;
  --analysis-color: #0078D4;
  --upload-color: #ffffff;
}
```

### 3.2 主题状态管理

```typescript
// src/stores/themeStore.ts
export const useThemeStore = defineStore('theme', () => {
  const theme = ref<Theme>((localStorage.getItem('theme') as Theme) || 'light')
  
  // 应用主题到DOM
  const applyTheme = (newTheme: Theme) => {
    document.documentElement.setAttribute('data-theme', newTheme)
  }
  
  // 主题切换
  const toggleTheme = async () => {
    const { useThemeOptimization } = await import('@/composables/useThemeOptimization')
    const { optimizedToggleTheme } = useThemeOptimization()
    await optimizedToggleTheme()
  }
  
  // 监听主题变化
  watch(theme, (newTheme) => {
    applyTheme(newTheme)
    localStorage.setItem('theme', newTheme)
  }, { immediate: true })
  
  return { theme, toggleTheme, setTheme }
})
```

### 3.3 主题优化机制

```typescript
// src/composables/useThemeOptimization.ts
export function useThemeOptimization() {
  const optimizedToggleTheme = async () => {
    const newTheme = themeStore.theme === 'light' ? 'dark' : 'light'
    
    // 1. 同步更新CSS变量
    const root = document.documentElement
    const newThemeVars = getThemeVariables(newTheme)
    Object.entries(newThemeVars).forEach(([key, value]) => {
      root.style.setProperty(key, value)
    })
    
    // 2. 同步更新data-theme属性
    root.setAttribute('data-theme', newTheme)
    
    // 3. 同步更新store状态
    themeStore.setTheme(newTheme)
    
    // 4. 触发地图主题更新事件
    window.dispatchEvent(new CustomEvent('themeChanged', {
      detail: { theme: newTheme }
    }))
  }
}
```

## 4. 地图配置管理

### 4.1 图层配置结构

```typescript
// src/types/map.ts
export interface Wuhanlayer {
  name: string
  type: 'point' | 'line' | 'polygon' | 'raster'
  visible: boolean
  group: string
  datasetName: string
  dataService: string
  lazyLoad: boolean
}

export interface APIConfig {
  baseUrl: string
  mapService: string
  dataService: string
  datasetName: string
  wuhanlayers: Wuhanlayer[]
  baseMaps: BaseMapConfig
  fallbackBaseMaps: BaseMapConfig
  mapBounds: {
    extent: [number, number, number, number]
    center: [number, number]
    zoom: number
  }
}
```

### 4.2 图层配置定义

```typescript
// src/utils/config.ts - 图层配置
wuhanlayers: [
  // 县级行政区图层
  { 
    name: `武汉_县级@${workspace}@@武汉`, 
    type: 'polygon', 
    visible: true, 
    group: '县级行政区',
    datasetName: 'wuhan_map_县级',
    dataService: `${mapService}/maps/${mapName}`,
    lazyLoad: false
  },
  
  // 交通水系一体化图层
  { 
    name: `公路@${workspace}@@武汉`, 
    type: 'line', 
    visible: false, 
    group: '城市基本信息',
    datasetName: '公路',
    dataService: `${mapService}/maps/${mapName}`,
    lazyLoad: true
  },
  
  // 水系图层
  { 
    name: `水系面@${workspace}@@${mapName}`, 
    type: 'polygon', 
    visible: false, 
    group: '城市基本信息',
    datasetName: '水系面',
    dataService: `${mapService}/maps/${mapName}`,
    lazyLoad: true
  }
]
```

### 4.3 地图配置生成

```typescript
// src/stores/mapStore.ts
const createMapConfig = (): MapConfig => {
  const apiConfig = createAPIConfig()
  
  return {
    baseUrl: getFullUrl('map'),
    dataUrl: getFullUrl('data'),
    datasetName: apiConfig.datasetName,
    vectorlayers: vectorlayerConfigs,
    center: apiConfig.mapBounds.center,
    zoom: apiConfig.mapBounds.zoom,
    projection: 'EPSG:4326',
    extent: apiConfig.mapBounds.extent
  }
}
```

## 5. API服务配置

### 5.1 多环境API配置

```typescript
// src/api/config.ts
const userServiceConfigs: Record<string, APIConfig> = {
  development: {
    baseUrl: 'http://localhost:8088/api/v1',
    timeout: 10000,
    retryCount: 3,
  },
  production: {
    baseUrl: 'https://your-production-api.com/api',
    timeout: 15000,
    retryCount: 3,
    apiKey: import.meta.env.VITE_API_KEY,
  }
}

const analysisServiceConfigs: Record<string, APIConfig> = {
  development: {
    baseUrl: 'http://localhost:8087/api/v1',
    timeout: 30000,
    retryCount: 3,
  },
  production: {
    baseUrl: 'https://your-analysis-api.com/api/v1',
    timeout: 45000,
    retryCount: 3,
    apiKey: import.meta.env.VITE_ANALYSIS_API_KEY,
  }
}
```

### 5.2 配置获取函数

```typescript
// 获取用户服务配置
export function getUserServiceConfig(): APIConfig {
  const env = import.meta.env.MODE || 'development'
  return userServiceConfigs[env] || userServiceConfigs.development
}

// 获取分析服务配置
export function getAnalysisServiceConfig(): APIConfig {
  const env = import.meta.env.MODE || 'development'
  return analysisServiceConfigs[env] || analysisServiceConfigs.development
}

// 创建API客户端配置
export function createUserServiceAPIClientConfig() {
  const config = getUserServiceConfig()
  return {
    baseURL: config.baseUrl,
    timeout: config.timeout,
    headers: {
      'Content-Type': 'application/json',
      ...(config.apiKey && { Authorization: `Bearer ${config.apiKey}` }),
    },
  }
}
```

## 6. 路由配置管理

### 6.1 路由配置结构

```typescript
// src/router/index.ts
const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/',
      redirect: '/dashboard'
    },
    {
      path: '/login',
      name: 'login',
      component: Login,
      meta: { 
        requiresAuth: false,
        title: '系统登录'
      }
    },
    {
      path: '/profile',
      name: 'profile',
      component: UserProfile,
      meta: { 
        requiresAuth: true,
        title: '个人中心'
      }
    }
  ]
})
```

### 6.2 路由元数据配置

- `requiresAuth`: 是否需要认证
- `title`: 页面标题
- `permissions`: 权限要求
- `layout`: 布局类型

## 7. 配置管理最佳实践

### 7.1 配置分离原则

- **环境分离**：开发、测试、生产环境使用不同的配置文件
- **功能分离**：不同类型配置使用不同的管理模块
- **敏感信息保护**：API密钥等敏感信息通过环境变量管理

### 7.2 配置验证机制

```typescript
// 配置验证函数
export const validateConfig = (config: APIConfig): boolean => {
  const requiredFields = ['baseUrl', 'mapService', 'dataService']
  return requiredFields.every(field => config[field])
}
```

### 7.3 配置热更新

- 支持运行时配置更新
- 主题切换实时生效
- 地图配置动态加载

### 7.4 配置缓存策略

- localStorage缓存用户偏好设置
- 主题设置持久化存储
- API配置按环境缓存

## 8. 配置调试和监控

### 8.1 配置调试工具

```typescript
// 配置测试函数
export const testLayerConfig = () => {
  const config = createAPIConfig()
  console.log('=== 图层配置测试 ===')
  config.wuhanlayers.forEach((layer, index) => {
    console.log(`${index + 1}. ${layer.name}`)
    console.log(`   类型: ${layer.type}`)
    console.log(`   组: ${layer.group}`)
    console.log(`   服务URL: ${config.baseUrl}/${layer.dataService}`)
  })
  return config
}
```

### 8.2 配置监控机制

- 配置加载状态监控
- 服务连接状态检查
- 主题切换性能监控

## 9. 配置部署和维护

### 9.1 环境变量设置

创建不同环境的配置文件：

```bash
# .env.development
VITE_SUPERMAP_BASE_URL=http://localhost:8090
VITE_SUPERMAP_MAP_SERVICE=iserver/services/map-xxx/rest
VITE_DEV_MODE=true

# .env.production
VITE_SUPERMAP_BASE_URL=https://your-production-server.com
VITE_SUPERMAP_MAP_SERVICE=iserver/services/map-xxx/rest
VITE_API_KEY=your-production-api-key
VITE_DEV_MODE=false
```

### 9.2 配置更新流程

1. **开发阶段**：修改配置文件，本地测试
2. **测试阶段**：部署到测试环境，验证配置
3. **生产阶段**：部署到生产环境，监控运行状态

### 9.3 配置备份和恢复

- 配置文件版本控制
- 配置变更记录
- 配置回滚机制

## 10. 总结

前端项目的配置设置管理采用分层架构设计，通过环境变量、主题系统、地图配置、API配置等多个维度实现全面的配置管理。系统支持动态配置更新、主题实时切换、多环境部署等功能，为项目的可维护性和可扩展性提供了坚实的基础。
