# 功能实现方法

## 🏗️ 整体架构设计

### **组合式函数层级结构**
```
应用根组件 (App.vue)
    ↓
页面级组件 (Dashboard.vue)
    ↓
仪表板布局 (DashboardLayout.vue)
    ↓
功能区域组件
    ├── 地图区域 (SuperMapViewer.vue) → useMap()
    ├── 图层管理 (LayerManager.vue) → useLayerManager()
    ├── 要素选择 (FeatureSelection.vue) → useFeatureSelection()
    ├── 要素查询 (FeatureQueryPanel.vue) → useFeatureQuery()
    └── 分析工具面板
        ├── 缓冲区分析 (BufferAnalysisPanel.vue) → useBufferAnalysis()
        ├── 叠加分析 (OverlayAnalysisPanel.vue) → useOverlayAnalysis()
        ├── 最短路径分析 (ShortestPathAnalysisPanel.vue) → useShortestPathAnalysis()
        
```

## 🗺️ 地图核心功能 (useMap)

### **功能描述**
地图显示、交互、样式管理的核心组合式函数

### **调用的函数**
- `createLayerStyle()` - 创建图层样式
- `updateLayerStyles()` - 更新图层样式
- `createMap()` - 创建地图实例
- `addLayer()` - 添加图层
- `removeLayer()` - 移除图层
- `setMapView()` - 设置地图视图
- `handleMapClick()` - 处理地图点击
- `handleMapHover()` - 处理地图悬停
- `handleMapSelect()` - 处理地图选择

### **存储的状态**
- `mapContainer` - 地图容器引用
- `hoverTimer` - 悬停定时器
- `selectSourceRef` - 选择图层源引用
- `disposers` - 清理函数数组

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useSelectionStore` - 选择状态管理
- `usePopupStore` - 弹窗状态管理
- `useAnalysisStore` - 分析状态管理
- `useLoadingStore` - 加载状态管理
- `useThemeStore` - 主题状态管理

## 🎛️ 图层管理功能 (useLayerManager)

### **功能描述**
图层显示控制、样式管理、要素操作的组合式函数

### **调用的函数**
- `clearLayerSelection()` - 清除图层选择高亮
- `toggleLayerVisibility()` - 切换图层可见性
- `updateLayerOpacity()` - 更新图层透明度
- `saveFeaturesAsLayer()` - 保存要素为新图层
- `exportLayerData()` - 导出图层数据
- `importLayerData()` - 导入图层数据

### **存储的状态**
- `confirmDialogVisible` - 确认对话框可见性
- `confirmDialogConfig` - 确认对话框配置

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useSelectionStore` - 选择状态管理
- `usePopupStore` - 弹窗状态管理
- `useAnalysisStore` - 分析状态管理

## 🎯 要素选择功能 (useFeatureSelection)

### **功能描述**
要素选择、高亮、几何计算的组合式函数

### **调用的函数**
- `calculateLineLength()` - 计算线长度
- `calculatePolygonArea()` - 计算多边形面积
- `haversineDistance()` - 计算球面距离
- `getFeatureType()` - 获取要素类型
- `getFeatureCoords()` - 获取要素坐标
- `getFeatureGeometryInfo()` - 获取要素几何信息
- `createBoxSelectInteraction()` - 创建框选交互
- `handleFeatureSelection()` - 处理要素选择

### **存储的状态**
- `boxSelectInteraction` - 框选交互引用
- `highlightedFeature` - 高亮要素引用
- `selectedFeatures` - 选中要素列表（computed）
- `selectedFeatureIndex` - 选中要素索引（computed）

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useAnalysisStore` - 分析状态管理
- `useAreaSelectionStore` - 区域选择状态管理
- `usePopupStore` - 弹窗状态管理

## 🔍 要素查询功能 (useFeatureQuery)

### **功能描述**
要素查询、高亮、结果管理的组合式函数

### **调用的函数**
- `executeQuery()` - 执行查询
- `getLayerFields()` - 获取图层字段
- `highlightQueryResults()` - 高亮查询结果
- `handleSelectFeature()` - 处理要素选择
- `highlightFeatureOnMap()` - 在地图上高亮要素
- `triggerMapFeatureHighlight()` - 触发地图要素高亮
- `removeHighlightFeature()` - 移除要素高亮
- `isSameFeature()` - 判断是否为同一要素

### **存储的状态**
- `selectedLayerId` - 选中的图层ID（computed）
- `queryResults` - 查询结果（computed）
- `layerFields` - 图层字段（computed）
- `queryConfig` - 查询配置（computed）
- `isQuerying` - 是否正在查询（computed）
- `lastExecutedQuery` - 最后执行的查询（computed）
- `selectedFeatureIndex` - 选中的要素索引（computed）
- `highlightedFeature` - 高亮的要素（computed）

### **依赖的Store**
- `useFeatureQueryStore` - 要素查询状态管理

## 📊 缓冲区分析功能 (useBufferAnalysis)

### **功能描述**
缓冲区分析、参数设置、结果管理的组合式函数

### **调用的函数**
- `saveState()` - 保存分析状态
- `restoreState()` - 恢复分析状态
- `clearState()` - 清理分析状态
- `executeBufferAnalysis()` - 执行缓冲区分析
- `removeBufferLayers()` - 移除缓冲区图层
- `exportBufferResults()` - 导出缓冲区结果

### **存储的状态**
- `selectedAnalysisLayerId` - 选中的分析图层ID
- `bufferSettings` - 缓冲区设置参数
- `bufferResults` - 缓冲区分析结果
- `currentResult` - 当前结果
- `isAnalyzing` - 是否正在分析

### **依赖的Store**
- `useAnalysisStore` - 分析状态管理
- `useMapStore` - 地图状态管理



## 🔗 叠加分析功能 (useOverlayAnalysis)

### **功能描述**
几何叠加分析、操作类型管理、结果处理的组合式函数

### **调用的函数**
- `executeOverlayAnalysis()` - 执行叠加分析
- `performGeometryOverlay()` - 执行几何叠加
- `saveOverlayResult()` - 保存叠加结果
- `clearOverlayResult()` - 清理叠加结果
- `exportOverlayResult()` - 导出叠加结果

### **存储的状态**
- `selectedLayer1` - 选中的第一个图层
- `selectedLayer2` - 选中的第二个图层
- `selectedOperation` - 选中的操作类型
- `overlayResult` - 叠加分析结果
- `isAnalyzing` - 是否正在分析

### **依赖的Store**
- `useAnalysisStore` - 分析状态管理
- `useMapStore` - 地图状态管理

## 🛣️ 最短路径分析功能 (useShortestPathAnalysis)

### **功能描述**
最短路径分析、障碍物处理、结果可视化的组合式函数

### **调用的函数**
- `displayAnalysisResults()` - 显示分析结果
- `removePathLayersOnly()` - 仅移除路径图层
- `removeAllAnalysisLayers()` - 移除所有分析图层
- `executePathAnalysis()` - 执行路径分析
- `savePathResult()` - 保存路径结果
- `exportPathResults()` - 导出路径结果

### **存储的状态**
- `analysisResults` - 分析结果列表
- `layerName` - 图层名称
- `isSelectingStartPoint` - 是否正在选择起始点
- `isSelectingEndPoint` - 是否正在选择目标点
- `startPoint` - 起始点
- `endPoint` - 目标点
- `analysisLayers` - 分析图层引用

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useAnalysisStore` - 分析状态管理





## 🔄 状态管理流程

### **分析工具状态管理**
```
用户操作 → 组合式函数 → Store状态更新 → 组件重新渲染 → 地图更新
```

### **数据流向**
```
API调用 → 数据处理 → Store存储 → 组件读取 → 界面展示
```

### **事件传递链**
```
地图交互 → 组合式函数 → Store更新 → 其他组件响应 → 界面同步
```

## 📋 功能依赖关系表

| 功能模块 | 主要组合式函数 | 依赖Store | 主要状态 |
|---------|---------------|-----------|----------|
| 地图核心 | useMap | MapStore, SelectionStore, PopupStore, AnalysisStore, LoadingStore, ThemeStore | 地图实例、图层、交互状态 |
| 图层管理 | useLayerManager | MapStore, SelectionStore, PopupStore, AnalysisStore | 图层可见性、透明度、选择状态 |
| 要素选择 | useFeatureSelection | MapStore, AnalysisStore, AreaSelectionStore, PopupStore | 选中要素、高亮状态、几何信息 |
| 要素查询 | useFeatureQuery | FeatureQueryStore | 查询结果、选中要素、高亮状态 |
| 缓冲区分析 | useBufferAnalysis | AnalysisStore, MapStore | 分析参数、结果、图层状态 |

| 叠加分析 | useOverlayAnalysis | AnalysisStore, MapStore | 选中图层、操作类型、分析结果 |
| 最短路径分析 | useShortestPathAnalysis | MapStore, AnalysisStore | 路径结果、分析图层、交互状态 |


## 🎨 主题系统集成

### **CSS变量引用**
- 图层样式使用 `--layer-stroke-${layerName}` 和 `--layer-fill-${layerName}`
- 选择高亮使用 `--map-select-fill` 和 `--map-highlight-color`
- 主题色使用 `--accent` 作为fallback

### **主题切换响应**
- 所有组合式函数通过 `useThemeStore` 响应主题变化
- 地图样式自动更新以匹配当前主题
- 分析结果样式跟随主题切换

## 🔧 工具状态持久化

### **状态保存机制**
- 使用 `useModeStateStore` 保存工具状态
- 支持参数、结果、图层名称的持久化
- 工具切换时自动恢复上次状态

### **状态清理机制**
- 工具切换时自动清理分析结果
- 移除临时分析图层
- 重置交互状态

