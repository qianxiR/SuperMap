# 功能实现方法

## 🏗️ 整体架构设计

### **组合式函数层级结构**
```
应用根组件 (App.vue)
    ↓
页面级组件 (Dashboard.vue)
    ↓
仪表板布局 (DashboardLayout.vue)
    ↓
功能区域组件
    ├── 地图区域 (SuperMapViewer.vue) → useMap()
    ├── 图层管理 (layermanager.vue) → uselayermanager()
    ├── 要素选择 (FeatureSelection.vue) → useFeatureSelection()
    ├── 要素查询 (FeatureQueryPanel.vue) → useFeatureQuery()
    └── 分析工具面板
        ├── 缓冲区分析 (BufferAnalysisPanel.vue) → useBufferAnalysis()
        ├── 叠置分析 (intersectAnalysisPanel.vue) → useintersectAnalysis()
        ├── 最短路径分析 (ShortestPathAnalysisPanel.vue) → useShortestPathAnalysis()
        
```

## 🗺️ 地图核心功能 (useMap)

### **功能描述**
地图显示、交互、样式管理的核心组合式函数

### **调用的函数**
- `createlayerStyle()` - 创建图层样式
- `updatelayerStyles()` - 更新图层样式并同步主题
- `initMap()` - 初始化地图与底图、业务图层、事件与样式
- `cleanup()` - 清理事件与资源
- `queryFeaturesAtPoint()` - 基于坐标点聚合命中要素并生成弹窗内容

### **存储的状态**
- `mapContainer` - 地图容器引用
- `hoverTimer` - 悬停定时器
- `selectSourceRef` - 选择图层源引用
- `disposers` - 清理函数数组

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useSelectionStore` - 选择状态管理
- `usePopupStore` - 弹窗状态管理
- `useAnalysisStore` - 分析状态管理
- `useLoadingStore` - 加载状态管理
- `useThemeStore` - 主题状态管理

## 🎛️ 图层管理功能 (uselayermanager)

### **功能描述**
图层显示控制、样式管理、要素操作的组合式函数

### **调用的函数**
- `clearlayerSelection(layerName)` - 清除指定图层在选择层上的高亮与关联状态
- `togglelayerVisibility(layerId)` - 切换图层可见性并同步清理选择/弹窗/查询高亮
- `removelayer(layerId)` - 从地图与管理列表移除图层
- `isDrawingMode()` - 是否处于绘制模式
- `handleDrawClear()` - 清空绘制图层内容
- `saveDrawAslayer()` - 将绘制结果保存为新图层
- `saveFeaturesAslayer(features, layerName, sourceType)` - 通用要素保存为图层
- `showConfirmDialog()/handleConfirmDialog*()` - 确认对话框控制

### **存储的状态**
- `confirmDialogVisible` - 确认对话框可见性
- `confirmDialogConfig` - 确认对话框配置

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useSelectionStore` - 选择状态管理
- `usePopupStore` - 弹窗状态管理
- `useAnalysisStore` - 分析状态管理

## 🎯 要素选择功能 (useFeatureSelection)

### **功能描述**
要素选择、高亮、几何计算的组合式函数

### **调用的函数**
- `calculateLineLength()` - 计算线长度
- `calculatePolygonArea()` - 计算多边形面积
- `haversineDistance()` - 计算球面距离
- `getFeatureType()` - 获取要素类型
- `getFeatureCoords()` - 获取要素坐标描述
- `getFeatureGeometryInfo()` - 获取几何描述信息
- `createBoxSelectInteraction()` - 创建框选交互
- `setupSelectionInteractions()/clearSelectionInteractions()` - 挂载/卸载区域选择交互
- `selectFeaturesInExtent(extent)` - 区域范围选择要素
- `highlightFeatureOnMap(feature)` - 在选择层高亮要素
- `triggerMapFeatureHighlight(feature)` - 触发地图常亮动画样式
- `removeHighlightFeature()` - 取消常亮并恢复样式
- `handleSelectFeature(index)` - 列表点击选中并高亮要素
- `invertSelectedlayer()` - 基于当前选集进行反选
- `initializeHighlightFeatures()` - 组件初始化回填高亮

### **存储的状态**
- `boxSelectInteraction` - 框选交互引用
- `highlightedFeature` - 高亮要素引用
- `selectedFeatures` - 选中要素列表（computed）
- `selectedFeatureIndex` - 选中要素索引（computed）

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useAnalysisStore` - 分析状态管理
- `useAreaSelectionStore` - 区域选择状态管理
- `usePopupStore` - 弹窗状态管理

## 🔍 要素查询功能 (useFeatureQuery)

### **功能描述**
要素查询、高亮、结果管理的组合式函数

### **调用的函数**
- `executeQuery()` - 执行查询
- `getlayerFields()` - 获取图层字段
- `highlightQueryResults()` - 高亮查询结果
- `handleSelectFeature()` - 处理要素选择
- `highlightFeatureOnMap()` - 在地图上高亮要素
- `triggerMapFeatureHighlight()` - 触发地图要素高亮
- `removeHighlightFeature()` - 移除要素高亮
- `isSameFeature()` - 判断是否为同一要素
- `clearSelectedlayer()/invertSelectedlayer()` - 图层选择清空/反选
- `getlayerOptions()/getSelectedlayerName()/getlayerFeatureCount()` - 查询面板辅助

### **存储的状态**
- `selectedlayerId` - 选中的图层ID（computed）
- `queryResults` - 查询结果（computed）
- `layerFields` - 图层字段（computed）
- `queryConfig` - 查询配置（computed）
- `isQuerying` - 是否正在查询（computed）
- `lastExecutedQuery` - 最后执行的查询（computed）
- `selectedFeatureIndex` - 选中的要素索引（computed）
- `highlightedFeature` - 高亮的要素（computed）

### **依赖的Store**
- `useFeatureQueryStore` - 要素查询状态管理

## 📊 缓冲区分析功能 (useBufferAnalysis)

### **功能描述**
缓冲区分析、参数设置、结果管理的组合式函数

### **调用的函数**
- `setSelectedAnalysislayer(layerId)` - 设置分析目标图层
- `executeBufferAnalysis()` - 执行缓冲区分析（turf.buffer）
- `displayBufferResults(results)` - 在地图上渲染分析结果
- `removeBufferlayers()` - 移除缓冲区结果图层
- `clearAllSelections()` - 清除图层显示但保留状态
- `updateBufferSettings(partial)` - 更新缓冲区参数
- `clearState()` - 清理分析结果与缓冲区图层

### **存储的状态**
- `selectedAnalysislayerId` - 选中的分析图层ID
- `selectedAnalysislayerInfo` - 当前选择图层的概要信息
- `layerOptions` - 可用矢量图层选项（仅可见层）
- `bufferSettings` - 缓冲区设置参数（半径、圆弧分段）
- `bufferResults` - 缓冲区分析结果
- `currentResult` - 当前结果
- `isAnalyzing` - 是否正在分析

### **依赖的Store**
- `useAnalysisStore` - 分析状态管理
- `useMapStore` - 地图状态管理
- `useBufferAnalysisStore` - 缓冲区分析状态



## 🔗 叠置分析功能 (useintersectAnalysis)

### **功能描述**
几何叠置分析、操作类型管理、结果处理的组合式函数

### **调用的函数**
- `executeintersectAnalysis()` - 执行叠置分析
- `performGeometryintersect(features1, features2, operation)` - 使用 Turf 进行叠加
- `displayAnalysisResults(results)` - 地图渲染叠加结果
- `removeAnalysislayers()` - 清理叠加结果图层
- `clearResult()` - 清空结果
- `exportResult()` - 导出叠加结果
- `saveAnalysislayer(customlayerName?)` - 保存为新图层
- `clearAll()` - 清空选择项与图层

### **存储的状态**
- `selectedlayer1` - 选中的第一个图层
- `selectedlayer2` - 选中的第二个图层
- `selectedOperation` - 选中的操作类型
- `intersectResult` - 叠置分析结果
- `isAnalyzing` - 是否正在分析
- `availablelayers` - 可用图层（可见矢量层）
- `canAnalyze` - 是否允许点击分析（放宽校验，按钮可用）

### **依赖的Store**
- `useAnalysisStore` - 分析状态管理
- `useMapStore` - 地图状态管理

## 🛣️ 最短路径分析功能 (useShortestPathAnalysis)

### **功能描述**
最短路径分析、障碍物处理、结果可视化的组合式函数

### **调用的函数**
- `selectStartPoint()/selectEndPoint()` - 地图点击设置两个分析点
- `displayAnalysisResults(results)` - 显示路径结果
- `removePathlayersOnly()` - 仅移除路径图层
- `removeAnalysislayers()` - 移除全部分析相关图层
- `executePathAnalysis()` - 执行最短路径分析（turf.shortestPath）
- `saveAnalysislayer(customlayerName?)` - 保存路径与点为新图层
- `exportGeoJSON()` - 导出为json与点为GeoJSON
- `clearResults()` - 清理所有路径与点状态

### **存储的状态**
- `analysisResults` - 分析结果列表
- `layerName` - 图层名称
- `isSelectingStartPoint` - 是否正在选择起始点
- `isSelectingEndPoint` - 是否正在选择目标点
- `startPoint` - 起始点
- `endPoint` - 目标点
- `analysislayers` - 分析图层引用
- `startPointInfo/endPointInfo` - 点信息（computed）
- `canAnalyze` - 是否具备分析条件（computed）

### **依赖的Store**
- `useMapStore` - 地图状态管理
- `useAnalysisStore` - 分析状态管理





## 🔄 状态管理流程

### **分析工具状态管理**
```
用户操作 → 组合式函数 → Store状态更新 → 组件重新渲染 → 地图更新
```

### **数据流向**
```
API调用 → 数据处理 → Store存储 → 组件读取 → 界面展示
```

### **事件传递链**
```
地图交互 → 组合式函数 → Store更新 → 其他组件响应 → 界面同步
```

## 📋 功能依赖关系表

| 功能模块 | 主要组合式函数 | 依赖Store | 主要状态 |
|---------|---------------|-----------|----------|
| 地图核心 | useMap | MapStore, SelectionStore, PopupStore, AnalysisStore, LoadingStore, ThemeStore | 地图实例、图层、交互状态 |
| 图层管理 | uselayermanager | MapStore, SelectionStore, PopupStore, AnalysisStore | 图层可见性、透明度、选择状态 |
| 要素选择 | useFeatureSelection | MapStore, AnalysisStore, AreaSelectionStore, PopupStore | 选中要素、高亮状态、几何信息 |
| 要素查询 | useFeatureQuery | FeatureQueryStore | 查询结果、选中要素、高亮状态 |
| 缓冲区分析 | useBufferAnalysis | AnalysisStore, MapStore | 分析参数、结果、图层状态 |

| 叠置分析 | useintersectAnalysis | AnalysisStore, MapStore | 选中图层、操作类型、分析结果 |
| 最短路径分析 | useShortestPathAnalysis | MapStore, AnalysisStore | 路径结果、分析图层、交互状态 |


## 🎨 主题系统集成

### **CSS变量引用**
- 图层样式使用 `--layer-stroke-${layerName}` 和 `--layer-fill-${layerName}`
- 选择高亮使用 `--map-select-fill` 和 `--map-highlight-color`
- 主题色使用 `--accent` 作为fallback

### **主题切换响应**
- 所有组合式函数通过 `useThemeStore` 响应主题变化
- 地图样式自动更新以匹配当前主题
- 分析结果样式跟随主题切换

## 🔧 工具状态持久化

### **状态保存机制**
- 使用 `useModeStateStore` 保存工具状态
- 支持参数、结果、图层名称的持久化
- 工具切换时自动恢复上次状态

### **状态清理机制**
- 工具切换时自动清理分析结果
- 移除临时分析图层
- 重置交互状态

