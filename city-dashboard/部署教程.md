# 城市仪表板部署教程

## 项目概述

这是一个基于 Vue 3 + TypeScript 的智能城市管理平台，集成了 SuperMap GIS 功能，提供地图可视化、空间分析等功能。

## 系统要求

### 必要环境
- **Node.js**: ^20.19.0 || >=22.12.0
- **npm**: 10.x 或更高版本

### 推荐配置
- 操作系统: Windows 10/11, macOS 10.15+, Linux (Ubuntu 18.04+)
- 内存: 8GB 或以上
- 存储: 至少 2GB 可用空间

## 开发环境部署

### 1. 环境准备

#### 安装 Node.js
1. 访问 [Node.js 官网](https://nodejs.org/)
2. 下载并安装推荐版本（LTS）
3. 验证安装：
```bash
node --version
npm --version
```

### 2. 项目初始化

#### 克隆项目
```bash
git clone <your-repository-url>
cd city-dashboard
```

#### 安装依赖
```bash
npm install
```

### 3. 开发服务器启动

#### 启动开发服务器
```bash
npm run dev
```

服务器将在 `http://localhost:5173` 启动，支持热重载。

#### 验证启动
1. 浏览器访问 `http://localhost:5173`
2. 检查控制台无报错
3. 确认地图和UI组件正常显示

## 生产环境部署

### 1. 构建项目

#### 执行构建命令
```bash
npm run build
```

构建产物将输出到 `dist/` 目录。

#### 预览构建结果
```bash
npm run preview
```

### 2. 静态资源服务器部署

#### 使用 Nginx

**安装 Nginx**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
# 或
sudo dnf install nginx
```

**配置 Nginx**
创建配置文件 `/etc/nginx/sites-available/city-dashboard`:

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为实际域名
    
    root /var/www/city-dashboard;  # 替换为实际路径
    index index.html;
    
    # 处理 Vue Router 的历史模式
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

**部署步骤**
```bash
# 复制构建产物到服务器目录
sudo cp -r dist/* /var/www/city-dashboard/

# 设置权限
sudo chown -R www-data:www-data /var/www/city-dashboard
sudo chmod -R 755 /var/www/city-dashboard

# 启用站点
sudo ln -s /etc/nginx/sites-available/city-dashboard /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 使用 Apache

**安装 Apache**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install apache2

# CentOS/RHEL
sudo yum install httpd
# 或
sudo dnf install httpd
```

**配置虚拟主机**
创建配置文件 `/etc/apache2/sites-available/city-dashboard.conf`:

```apache
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /var/www/city-dashboard
    
    <Directory /var/www/city-dashboard>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # Vue Router 历史模式支持
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </IfModule>
    
    ErrorLog ${APACHE_LOG_DIR}/city-dashboard_error.log
    CustomLog ${APACHE_LOG_DIR}/city-dashboard_access.log combined
</VirtualHost>
```

**部署步骤**
```bash
# 复制构建产物
sudo cp -r dist/* /var/www/city-dashboard/

# 设置权限
sudo chown -R www-data:www-data /var/www/city-dashboard
sudo chmod -R 755 /var/www/city-dashboard

# 启用站点
sudo a2ensite city-dashboard.conf

# 启用必要模块
sudo a2enmod rewrite

# 重启 Apache
sudo systemctl restart apache2
```

### 3. Docker 部署

#### 创建 Dockerfile
```dockerfile
# 构建阶段
FROM node:20-alpine as build-stage

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建项目
RUN npm run build

# 生产阶段
FROM nginx:alpine as production-stage

# 复制构建产物到 Nginx 目录
COPY --from=build-stage /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 创建 nginx.conf
```nginx
server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

#### 构建和运行
```bash
# 构建镜像
docker build -t city-dashboard .

# 运行容器
docker run -d -p 8080:80 --name city-dashboard-app city-dashboard
```

#### 使用 docker-compose
创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  city-dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    restart: unless-stopped
    container_name: city-dashboard-app
```

运行：
```bash
docker-compose up -d
```

## 云平台部署

### 1. Vercel 部署

#### 准备工作
1. 注册 [Vercel](https://vercel.com) 账号
2. 安装 Vercel CLI：
```bash
npm i -g vercel
```

#### 部署步骤
```bash
# 登录 Vercel
vercel login

# 部署项目
vercel

# 或一键部署
vercel --prod
```

#### 配置文件 vercel.json（可选）
```json
{
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}
```

### 2. Netlify 部署

#### 通过 Git 连接
1. 访问 [Netlify](https://www.netlify.com)
2. 点击 "New site from Git"
3. 连接 Git 仓库
4. 配置构建设置：
   - Build command: `npm run build`
   - Publish directory: `dist`

#### 创建 _redirects 文件
在 `public/` 目录下创建 `_redirects` 文件：
```
/*    /index.html   200
```

### 3. GitHub Pages 部署

#### 创建 GitHub Actions
在 `.github/workflows/deploy.yml`:

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build
    
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
```

## 环境配置

### 1. 环境变量

创建环境配置文件：

#### .env.development（开发环境）
```bash
# 开发环境配置
VITE_APP_TITLE=城市仪表板 - 开发环境
VITE_BASE_URL=http://localhost:5173
VITE_API_BASE_URL=http://localhost:3000/api
VITE_SUPERMAP_SERVER=http://localhost:8090
```

#### .env.production（生产环境）
```bash
# 生产环境配置
VITE_APP_TITLE=城市仪表板
VITE_BASE_URL=https://your-domain.com
VITE_API_BASE_URL=https://api.your-domain.com
VITE_SUPERMAP_SERVER=https://supermap.your-domain.com
```

### 2. SuperMap 服务配置

#### 本地 SuperMap 服务
```bash
# 确保 SuperMap iServer 服务运行在指定端口
# 默认: http://localhost:8090/iserver
```

#### 云端 SuperMap 服务
更新配置文件中的服务地址：
```javascript
// src/config/map.js
export const SUPERMAP_CONFIG = {
  serverUrl: 'https://your-supermap-server.com/iserver',
  // 其他配置...
}
```

## 域名和 SSL 配置

### 1. 域名解析
```bash
# 添加 A 记录指向服务器 IP
your-domain.com -> 192.168.1.100
```

### 2. SSL 证书配置

#### 使用 Let's Encrypt（推荐）
```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书（Nginx）
sudo certbot --nginx -d your-domain.com

# 或手动获取证书
sudo certbot certonly --standalone -d your-domain.com
```

#### Nginx SSL 配置
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # 其他配置...
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## 性能优化

### 1. 构建优化

#### Vite 配置优化
```javascript
// vite.config.js
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['vue', 'pinia'],
          ui: ['ant-design-vue'],
          utils: ['splitpanes']
        }
      }
    },
    chunkSizeWarningLimit: 1000
  },
  server: {
    open: true,
    port: 5173
  }
})
```

### 2. 缓存策略

#### 服务器端缓存
```nginx
# 静态资源长期缓存
location ~* \.(js|css)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# HTML 文件不缓存
location ~* \.html$ {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

## 监控与维护

### 1. 日志配置

#### Nginx 访问日志
```nginx
log_format detailed '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" $request_time';

access_log /var/log/nginx/city-dashboard-access.log detailed;
error_log /var/log/nginx/city-dashboard-error.log;
```

### 2. 健康检查

#### 创建健康检查端点
在 `public/` 目录创建 `health.json`:
```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00Z",
  "version": "1.0.0"
}
```

### 3. 备份策略

#### 自动备份脚本
```bash
#!/bin/bash
# backup.sh

# 备份构建产物
tar -czf "city-dashboard-backup-$(date +%Y%m%d).tar.gz" /var/www/city-dashboard

# 清理旧备份（保留30天）
find /backup -name "city-dashboard-backup-*.tar.gz" -mtime +30 -delete
```

## 故障排除

### 1. 常见问题

#### 构建失败
```bash
# 清理缓存和依赖
rm -rf node_modules package-lock.json
npm install

# 检查 Node.js 版本
node --version
```

#### 地图无法加载
1. 检查 SuperMap 服务是否运行
2. 确认网络连接
3. 查看浏览器控制台错误

#### 路由404错误
确保服务器配置了正确的回退规则（try_files）

### 2. 性能问题

#### 首屏加载慢
1. 检查网络连接
2. 启用 gzip 压缩
3. 优化图片资源
4. 考虑 CDN 加速

#### 内存占用过高
1. 检查是否有内存泄露
2. 优化 Vue 组件
3. 减少不必要的响应式数据

## 安全建议

### 1. 服务器安全
- 定期更新系统和软件包
- 配置防火墙规则
- 使用强密码和密钥认证
- 定期备份数据

### 2. 应用安全
- 启用 HTTPS
- 配置 CSP（内容安全策略）
- 定期更新依赖包
- 输入验证和输出编码

### 3. 访问控制
```nginx
# 限制访问频率
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

location /api {
    limit_req zone=api burst=20 nodelay;
    # 其他配置...
}
```

## 结论

本教程涵盖了从开发环境搭建到生产环境部署的完整流程。根据实际需求选择合适的部署方式，并注意安全性和性能优化。如有问题，请参考项目文档或联系技术支持。

---

**更新日期**: 2024年8月14日  
**版本**: 1.0.0  
**维护**: 开发团队